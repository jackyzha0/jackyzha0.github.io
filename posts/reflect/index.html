<!doctype html><html lang=en><head><link rel=preconnect href=https://www.googletagmanager.com><link crossorigin rel=preconnect href=https://www.google-analytics.com><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-148413215-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><title>reflect: NLP Model Explained</title><meta name=description content="How do we tell that this is a “valid” intent?
A (not so) brief exploration of how we tackle classifying intents in reflect. Part 1 will touch on …"><link rel="shortcut icon" type=image/png href=/res/logo.png><meta name=viewport content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&family=Source+Sans+Pro:wght@400;600&family=Fira+Code:wght@400;700&display=swap" rel=stylesheet><style>:root{--light: #faf8f8;--dark: #141021;--navy: #284b63;--olive: #84a59d;--visited: #afbfc9;--salmon: #f28482;--gray: #4e4e4e;--lightgray: #f0f0f0;--outlinegray: #dadada;--lt-colours-light: var(--light) !important;--lt-colours-lightgray: var(--lightgray) !important;--lt-colours-dark: var(--navy) !important;--lt-colours-secondary: var(--olive) !important;--lt-colours-gray: var(--outlinegray) !important;--invert-filter: invert(0) hue-rotate(0)}h1,h2,h3,h4,ol,ul,thead{font-family:Inter;color:var(--dark)}p,ul,text{font-family:source sans pro,sans-serif;color:var(--gray);fill:var(--gray)}pre{font-family:fira code;padding:.75em;border-radius:3px;overflow-x:scroll}code{font-family:fira code;font-size:.85em;padding:.15em .3em;border-radius:5px;background:var(--lightgray)}[saved-theme=dark]{--light: #1e1e21 !important;--dark: #fbfffe !important;--navy: #5b778a !important;--visited: #4a575e !important;--olive: #84a59d !important;--salmon: #f58382 !important;--gray: #d4d4d4 !important;--lightgray: #292633 !important;--outlinegray: #343434 !important;--invert-filter: invert(97%) hue-rotate(190deg) grayscale(0.4) contrast(90%) brightness(1.2) !important}html{scroll-behavior:smooth}body{margin:0;height:100vh;width:100vw;overflow-x:hidden;background-color:var(--light)}.hover{color:var(--dark);text-decoration:none;opacity:.6;z-index:1;transition:200ms}.hover::after{transition:200ms;height:18px;content:"";position:absolute;background-color:var(--olive);opacity:.5;z-index:-1;width:0%;right:5px;bottom:5px}@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}footer{margin-top:4em}footer>a{font-family:inter;font-weight:700;font-size:1em;color:var(--navy);padding:0 .5em 3em}#newsletter{margin:2em 0}#newsletter>input{padding:.7em 1em;border-radius:4px}#newsletter>input[type=submit]{border:none;color:var(--light);background-color:var(--navy);cursor:pointer}#newsletter>input[type=email]{background-color:var(--light);border:1px solid var(--outlinegray);-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;box-sizing:border-box}hr{width:25%;margin:4em auto;height:2px;border-radius:1px;border-width:0;color:var(--dark);background-color:var(--dark)}a[href^="/thoughts"],a[href^="/books"],a[href^="/classes"]{text-decoration:none;background-color:#afbfc922;padding:0 .2em;border-radius:3px}#contentWrapper,.singlePage{margin:25px 30vw}@media all and (max-width:1200px){#contentWrapper,.singlePage{margin:25px 5vw}}</style><style>#TableOfContents>ol{counter-reset:section;margin-left:0;padding-left:1.5em}#TableOfContents>ol>li{counter-increment:section}#TableOfContents>ol>li>ol{counter-reset:subsection}#TableOfContents>ol>li>ol>li{counter-increment:subsection}#TableOfContents>ol>li>ol>li::marker{content:counter(section)"." counter(subsection)"  "}#TableOfContents>ol>li::marker{content:counter(section)"  "}#TableOfContents>ol>li::marker,#TableOfContents>ol>li>ol>li::marker{font-family:Source Sans Pro;font-weight:700}.postLi{margin-bottom:1em}.postLi>.time{margin:0;margin-bottom:-1em!important;font-family:fira code;font-weight:400;font-size:.5em}.singlePost{display:flex;flex-direction:row;align-items:center;justify-content:space-between}.singlePost *{margin:.1em auto}.singlePost>.desc{flex:1}.singlePost>.desc>*{display:inline-block}header,#postTitle{display:flex;flex-direction:row;align-items:center;justify-content:space-between}nav>a{margin-left:2em}#postTitle h1{margin-right:2em}footer{margin-top:4em;text-align:center}.meta{margin-left:2em!important}@media all and (max-width:600px){header>nav{display:none}#postTitle{flex-direction:column;align-items:flex-start}}table{width:100%}img{width:100%;border-radius:3px;margin:1em 0}p>img+em{display:block;transform:translateY(-1em)}sup{line-height:0}.morePosts{min-height:3em}.postLink{display:inline-block}.postLink.next{float:right}</style><style>a{font-family:Inter;font-weight:700;text-decoration:none;transition:all .2s ease;color:var(--navy)}a:hover{color:var(--olive)!important}.postLink:visited{color:var(--visited)}#posts{list-style:none;padding:0;margin:0}p,tbody,li{font-family:Source Sans Pro;color:var(--gray);line-height:1.5em}input{font-family:Source Sans Pro;color:var(--gray)}h2{opacity:.85}h3{opacity:.75}blockquote{margin-left:0;border-left:3px solid var(--navy);padding-left:1em;transition:border-color .2s ease}blockquote:hover{border-color:var(--olive)}table{padding:1.5em}td,th{padding:.1em .5em}.footnotes p{margin:.5em 0}article a{font-family:Source Sans Pro;font-weight:600;text-decoration:underline;text-decoration-color:var(--olive);text-decoration-thickness:.15em}sup>a{text-decoration:none;padding:0 .1em 0 .2em}</style><style>.chroma{color:#f8f8f2;background-color:#282a36}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#ff79c6}.chroma .kc{color:#ff79c6}.chroma .kd{color:#8be9fd;font-style:italic}.chroma .kn{color:#ff79c6}.chroma .kp{color:#ff79c6}.chroma .kr{color:#ff79c6}.chroma .kt{color:#8be9fd}.chroma .na{color:#50fa7b}.chroma .nb{color:#8be9fd;font-style:italic}.chroma .nc{color:#50fa7b}.chroma .nf{color:#50fa7b}.chroma .nl{color:#8be9fd;font-style:italic}.chroma .nt{color:#ff79c6}.chroma .nv{color:#8be9fd;font-style:italic}.chroma .vc{color:#8be9fd;font-style:italic}.chroma .vg{color:#8be9fd;font-style:italic}.chroma .vi{color:#8be9fd;font-style:italic}.chroma .s{color:#f1fa8c}.chroma .sa{color:#f1fa8c}.chroma .sb{color:#f1fa8c}.chroma .sc{color:#f1fa8c}.chroma .dl{color:#f1fa8c}.chroma .sd{color:#f1fa8c}.chroma .s2{color:#f1fa8c}.chroma .se{color:#f1fa8c}.chroma .sh{color:#f1fa8c}.chroma .si{color:#f1fa8c}.chroma .sx{color:#f1fa8c}.chroma .sr{color:#f1fa8c}.chroma .s1{color:#f1fa8c}.chroma .ss{color:#f1fa8c}.chroma .m{color:#bd93f9}.chroma .mb{color:#bd93f9}.chroma .mf{color:#bd93f9}.chroma .mh{color:#bd93f9}.chroma .mi{color:#bd93f9}.chroma .il{color:#bd93f9}.chroma .mo{color:#bd93f9}.chroma .o{color:#ff79c6}.chroma .ow{color:#ff79c6}.chroma .c{color:#6272a4}.chroma .ch{color:#6272a4}.chroma .cm{color:#6272a4}.chroma .c1{color:#6272a4}.chroma .cs{color:#6272a4}.chroma .cp{color:#ff79c6}.chroma .cpf{color:#ff79c6}.chroma .gd{color:#8b080b}.chroma .ge{text-decoration:underline}.chroma .gh{font-weight:700}.chroma .gi{font-weight:700}.chroma .go{color:#44475a}.chroma .gu{font-weight:700}.chroma .gl{text-decoration:underline}.lntd:first-of-type>.chroma{padding-right:0}.chroma code{font-family:fira code!important;font-size:.85em;line-height:1em;background:0 0;padding:0}.chroma{border-radius:3px;margin:0}</style><style>.darkmode{text-align:right}.darkmode>.toggle{display:none;box-sizing:border-box}.darkmode>.toggle:checked+.toggle-button:after{left:50%}.darkmode>.toggle+.toggle-button{box-sizing:border-box;outline:0;display:inline-block;width:3em;height:1.5em;position:relative;cursor:pointer;border:2px solid var(--gray);user-select:none;padding:2px;transition:all .2s ease;border-radius:2em}.darkmode>.toggle+.toggle-button:after,.darkmode>.toggle+.toggle-button:before{position:relative;display:block;box-sizing:border-box;content:"";width:50%;height:100%}.darkmode>.toggle+.toggle-button:before{display:none}.darkmode>.toggle+.toggle-button:after{left:0;transition:all .2s ease;background:var(--gray);content:"";border-radius:1em}.darkmode #dayIcon{position:relative;width:20px;height:20px;top:-1.5px;margin:0 7px;fill:var(--gray)}.darkmode #nightIcon{position:relative;width:18px;height:18px;top:-2px;margin:0 7px;fill:var(--gray)}</style></head><body><div id=contentWrapper><header><h1><a href=/posts>jzhao.xyz</a></h1><div class=darkmode><label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06L6.439 8.561zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label class=toggle-button for=darkmode-toggle></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><div id=postTitle class=desc><h1>reflect: NLP Model Explained</h1><p>written May 10, 2020 // 19 min read</p></div><aside class=mainTOC><h3>Table of Contents</h3><nav id=TableOfContents><ol><li><a href=#the-problem>The problem</a></li><li><a href=#why-its-so-difficult>Why it’s so difficult</a></li><li><a href=#the-data>The data</a><ol><li><a href=#survey-data-444-entries>Survey data (444 entries)</a></li><li><a href=#closed-beta-790-entries>Closed Beta (790 entries)</a></li><li><a href=#closed-beta-corrections-37-entries>Closed Beta Corrections (37 entries)</a></li><li><a href=#so>So?</a></li></ol></li><li><a href=#data-augmentation>Data augmentation</a><ol><li><a href=#sentence-variation>Sentence Variation</a></li><li><a href=#sentence-negation>Sentence Negation</a></li><li><a href=#shuffled-sentences>Shuffled Sentences</a></li><li><a href=#garbage-sentences>Garbage Sentences</a></li><li><a href=#vocabulary-mix-sentences>Vocabulary-mix Sentences</a></li></ol></li><li><a href=#data-preprocessing>Data preprocessing</a><ol><li><a href=#strip-punctuation>Strip punctuation</a></li><li><a href=#make-everything-lowercase>Make everything lowercase</a></li><li><a href=#expand-contractions>Expand contractions</a></li><li><a href=#remove-stop-words>Remove stop words</a></li><li><a href=#tokenization>Tokenization</a></li><li><a href=#fixed-sequence-length>Fixed sequence length</a></li><li><a href=#finally>Finally</a></li></ol></li><li><a href=#whats-next>What’s next?</a></li><li><a href=#the-model>The model</a><ol><li><a href=#model-overview>Model Overview</a></li></ol></li><li><a href=#training-pipeline>Training pipeline</a></li><li><a href=#serving-the-model>Serving the model</a></li><li><a href=#future-improvement>Future improvement</a><ol><li><a href=#possible-models>Possible models</a></li><li><a href=#misclassifications>Misclassifications</a></li></ol></li><li><a href=#closing>Closing</a></li></ol></nav></aside><div id=mainText><p><img src=https://miro.medium.com/max/1400/1*yjCs2Mmcve8wNI1pdfXelw.png alt="An image of the reflect block page"><em>How do we tell that this is a “valid” intent?</em></p><p>A (not so) brief exploration of how we tackle classifying intents in reflect. Part 1 will touch on defining the problem we’re trying to solve, the data we have, and how we pre-processed it. Part 2 will focus on the architecture of the model we built, how well it does, and thoughts on improving it for the future.</p><h2 id=the-problem>The problem</h2><p>Classifying intents is at the core of reflect. When a user inputs an intent, its reflect’s job to figure out whether that intent should let them into the website.</p><blockquote><p>How do we make sure “do some marketing work for reflect” is classified as productive but “watch cute dog videos” isn’t?</p></blockquote><h2 id=why-its-so-difficult>Why it’s so difficult</h2><p>A lot of it comes down to the fact that natural language processing (NLP) is a very difficult task. What does the sentence “learn about physics” mean, and how is it semantically different from “asdflkj I can’t do work”?</p><p>We can’t just parse for keywords and just allow a user in if we see the word “work” because that word can mean different things in different contexts. For example, “I’m not doing any work right now” would have otherwise been classified as valid. Thus, we can employ the help of a machine learning algorithm to help us capture this deeper meaning.</p><p>Specifically, the form of machine learning we will be using is called <strong>supervised learning,</strong> in which we give an algorithm a bunch of labelled data, tell it what it’s doing wrong, and let it ‘learn.’ Through doing this, hopefully the algorithm will be able to generalize and make predictions on unseen data too.</p><h2 id=the-data>The data</h2><p>Of course, if we want to perform supervised learning, we’re going to need a lot of data. Where are we going to get all of it? Luckily, we were able to get it through 3 different sources.</p><h3 id=survey-data-444-entries>Survey data (444 entries)</h3><p>Our team sent out an interest survey in early January in which we asked 3 questions:</p><ol><li><p>How would you answer if you were trying to visit a distracting site while trying to focus? (eg. youtube, facebook, etc)</p></li><li><p>How would you answer if you were trying to visit a distracting site to take a quick break from your work? (eg. youtube, facebook, etc)</p></li><li><p>How would you answer if you were trying to visit a distracting site like Facebook but to do work? (e.g. make a marketing post)</p></li></ol><p>We used these answers to form the basis of our very first dataset. We ended up getting a surprising amount of entries, ending with 148 responses to 3 questions and totalling 444 different observations. Here’s what some of that data looks like after tidying it up:</p><blockquote><p>We classified any answer to Q1 as invalid and Q2 + Q3 as valid</p></blockquote><table><thead><tr><th>intent</th><th>valid</th></tr></thead><tbody><tr><td>I am watching a 5 minute video to take my mind off not being productive :/</td><td>no</td></tr><tr><td>I&rsquo;m just bored</td><td>no</td></tr><tr><td>I’m bored/tired and trying to relax</td><td>no</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr><tr><td>work is pretty boring, i need to take a quick break I just can&rsquo;t focus atm</td><td>yes</td></tr><tr><td>I finished all my work for today so I&rsquo;m going to take a break now!</td><td>yes</td></tr><tr><td>getting some advertising done for my club</td><td>yes</td></tr><tr><td>I need to make a post on Twitter for my job announcing the latest update to our site</td><td>yes</td></tr><tr><td>I&rsquo;m trying to network</td><td>yes</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h3 id=closed-beta-790-entries>Closed Beta (790 entries)</h3><p>After we made a basic dataset, we were able to make our first (admittedly not great) model. But in doing so, this let us create an MVP to which we could use to actually test with. We then deployed this model for use to our closed beta testers and collected their responses (with consent of course!) along with the website it was input on. This was then converted into a .csv file. A few examples are show below:</p><table><thead><tr><th>intent</th><th>url</th></tr></thead><tbody><tr><td>to do some marketing</td><td>facebook.com/</td></tr><tr><td>i cannot focus on my work</td><td>instagram.com/</td></tr><tr><td>fuel my crippling social media addiction</td><td>facebook.com/</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p>These were then hand-labelled by our reflect team in a similar format as the survey data we collected earlier.</p><table><thead><tr><th>intent</th><th>valid</th></tr></thead><tbody><tr><td>to do some marketing</td><td>yes</td></tr><tr><td>i cannot focus on my work</td><td>no</td></tr><tr><td>fuel my crippling social media addiction</td><td>no</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h3 id=closed-beta-corrections-37-entries>Closed Beta Corrections (37 entries)</h3><p>Finally, we created a Google Forms through which we directly asked beta testers if a decision made by reflect’s intent classifier was faulty. Specifically, we asked what they input, and what they expected. Here are a few examples:</p><table><thead><tr><th>input</th><th>valid</th></tr></thead><tbody><tr><td>reply to a friend about a lab</td><td>yes</td></tr><tr><td>listening to a youtube music playlist</td><td>yes</td></tr><tr><td>goof off as much as possible</td><td>yes</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p>This entire section of the dataset was only 37 observations, but it drastically helped us reduce false positives and false negatives by focusing specifically on misclassifications.</p><p>After aggregating and combing all our data into one common format, we ended up with a grand total of 1271 observations. They looked something like this:</p><table><thead><tr><th>input</th><th>expected</th></tr></thead><tbody><tr><td>fail school by watching youtube</td><td>no</td></tr><tr><td>sdlkjasd</td><td>no</td></tr><tr><td>making a quick product post (should take &lt;10 min)</td><td>yes</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h3 id=so>So?</h3><p>Now that we have the data, can we just throw it into a machine learning model? Unfortunately, the answer is no, not quite yet.</p><h2 id=data-augmentation>Data augmentation</h2><p>Our dataset is still pretty small, even after aggregating all of our data. It most definitely doesn’t cover all of our bases for all the possible things that future users could possibly input. So, how can we “upsample” our data to get more of it? Well, it turns out that the field of Natural Language Processing has quite a few tricks to augment our data.</p><h3 id=sentence-variation>Sentence Variation</h3><p>Essentially what sentence variation is, is just replacing a few words of given sentences with their synonyms. If we have a sentence like “I’m trying to make a marketing post,” we can swap out singular words with their synonyms and tell our network that it means the same thing.</p><p>In this example, we could get something like “I’m attempting to fabricate a marketing post”. Adding these additional sentence variations will allow our machine learning model to learn semantic relationships between similar words (e.g. fabricate and make have similar meaning)</p><h3 id=sentence-negation>Sentence Negation</h3><p>Additionally, if we add a ‘not’ in the sentence, it should flip the meaning of the sentence. An example would be “learning about physics” is valid, whereas “not learning about physics” is not. However, if the sentence already contains ‘not’ (e.g. “I’m not being productive”), adding another ‘not’ would make the sentence too complex and obfuscated, so we just label it as invalid. In essence, we just add ‘not’ to a bunch of sentences and label them as invalid. This helps us to combat intents which use negations in a sort of round-a-bout way to confuse the algorithm.</p><h3 id=shuffled-sentences>Shuffled Sentences</h3><p>If we take an existing, valid sentence and completely shuffle the words, the resulting sentence should be invalid. An example would be “to watch a crash course video*” should be valid whereas “video course a watch crash to*” should be invalid. Basically, we’re just shuffling existing sentences and also labelling them as invalid. This helps us to combat intents which grammatically make no sense, but are otherwise valid.</p><h3 id=garbage-sentences>Garbage Sentences</h3><p>We can also take completely random words from the English language and put them together. The resulting sentences should all be invalid. For example, “*untinkered phalangitis shaly quinovic dish spadiciflorous unshaved” *clearly makes no sense. However, the addition of these gibberish sentences allows our model to be more robust against foreign words and out-of-vocabulary terms.</p><h3 id=vocabulary-mix-sentences>Vocabulary-mix Sentences</h3><p>Last but definitely not least, we can take the most common words in our dataset and mash them together. This should yield us a bunch of sentences which contain “key words” but should be marked as invalid because the context in which they are used makes no sense. For example, “video look watching” and “get research facebook take need want need message watch” are both clearly gibberish sentences, but they have a lot of keywords that one would think would let you in (e.g. video, research, watching, etc.). This lets us be more robust against those who try to get around the algorithm using keywords.</p><h2 id=data-preprocessing>Data preprocessing</h2><p>What about now? Can we throw it into the neural network yet? Well, no. We may have increased the amount of data we have to work with, but we also need to convert it to a form that is easy to understand for both the computer and for our algorithm. We do that with a series of functions that we apply on our data.</p><h3 id=strip-punctuation>Strip punctuation</h3><p>As the name suggests, we remove all punctuation from the input phrase. We found that including the punctuation hurt our performance, most likely due to the fact that they offer very little in terms of semantic meaning and obfuscate the real meaning of the sentence.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>stripPunctuation</span><span class=p>(</span><span class=s2>&#34;I don&#39;t know if I&#39;m being productive! :(&#34;</span><span class=p>)</span> 
<span class=o>&gt;</span> <span class=s2>&#34;I dont know if Im being productive&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=make-everything-lowercase>Make everything lowercase</h3><p>Additionally, we found that in this particular setting, capital letters also didn’t matter that much. Because of the nature we collect our data (just a simple textbox), users tend to not bother with capitalization. As such, we remove it to make it consistent across our data.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>lower</span><span class=p>(</span><span class=s2>&#34;I dont know if Im being productive&#34;</span><span class=p>)</span>
<span class=o>&gt;</span> <span class=s2>&#34;i dont know if im being productive&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=expand-contractions>Expand contractions</h3><p>The English language does this weird thing where we can just smush two words together (e.g. “I am” to “I’m”). Unfortunately for us, these produce extra complexity in our model that we could reduce by making them all consistent. In our case, we chose to expand all of these contractions.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>expandContractions</span><span class=p>(</span><span class=s2>&#34;i dont know if im being productive&#34;</span><span class=p>)</span> 
<span class=o>&gt;</span> <span class=s2>&#34;i do not know if i am being productive&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=remove-stop-words>Remove stop words</h3><p>The English language also has a bunch of these things called <strong>stop words</strong> — words that do not contribute anything major to the sentence in terms of semantic understanding (usually in the context of natural language tasks such as this). A few examples of them are ‘I’, ‘me’, ‘my’, ‘by’, and ‘on’. By removing them, we once again remove unneeded complexity from the model.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>rmStopwords</span><span class=p>(</span><span class=s2>&#34;i do not know if i am being productive&#34;</span><span class=p>)</span> 
<span class=o>&gt;</span> <span class=s2>&#34;not know productive&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=tokenization>Tokenization</h3><p>However, these words are not super friendly for machine learning algorithms who would much rather deal with integers and floating point numbers than words and sentences. How do we fix this?</p><p>Well, one thing we can do is turn words in indices by how often they appear, capped at the most common 1000 words — in essence, creating a vocabulary list mapping common words to numbers. For example, if “the” is the most common word, we convert it to 1. If “work” is the 8th most common word, we convert it to 8. For anything that isn’t in the top 1000, we give it the value of 0.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>tokenize</span><span class=p>(</span><span class=s2>&#34;not know productive&#34;</span><span class=p>)</span> 
<span class=o>&gt;</span> <span class=p>[</span><span class=mi>12</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>7</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><h3 id=fixed-sequence-length>Fixed sequence length</h3><p>Finally, we need to ensure that all the inputs are the same length of simplicity sake. If we were to handle dynamic length inputs, it would introduce a whole other level of complexity that we’re really not ready to deal with. As such, we can make sure all the inputs are the same length by adding a bunch of zeros to those who are too short (zero padding) or by slicing those who are too long.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>pad</span><span class=p>([</span><span class=mi>12</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>7</span><span class=p>],</span> <span class=mi>10</span><span class=p>)</span> 
<span class=o>&gt;</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>7</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><h3 id=finally>Finally</h3><p>After all of these functions have been applied, we have successfully converted a complex sentence into a series of ‘tokens’ that is easy to understand for the machine learning algorithm.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>preprocess</span><span class=p>(</span><span class=s2>&#34;I don’t know if I’m being productive! :(&#34;</span><span class=p>)</span>
<span class=o>&gt;</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>7</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><h2 id=whats-next>What’s next?</h2><p>Now that we have something ready to feed into our neural network, let’s dive into how the actual model itself works! How do we tell that this is a “valid” intent?</p><h2 id=the-model>The model</h2><p>The type of neural network that we’ll be using is called Long Short-Term Memory (LSTM).</p><p><img src=https://cdn-images-1.medium.com/max/4000/0*HyoZq6fOfsnn2YOC alt="credit: Christopher Olah, 2015"><em>credit: Christopher Olah, 2015</em></p><p>What’s so special about these networks is that they are really good at modelling time-series data, making it an ideal candidate for tasks like forecasting or natural language processing.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># Function to create a RNN model with given parameters</span>
<span class=c1># max_seq_len: maximum token sequence length</span>
<span class=c1># vocab_size:  size of tokenizer vocabulary</span>
<span class=k>def</span> <span class=nf>RNN</span><span class=p>(</span><span class=n>max_seq_len</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>):</span>
    <span class=n>inputs</span> <span class=o>=</span> <span class=n>Input</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;inputs&#39;</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=n>max_seq_len</span><span class=p>])</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Embedding</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=n>input_length</span><span class=o>=</span><span class=n>max_seq_len</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>LSTM</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>return_sequences</span> <span class=o>=</span> <span class=bp>True</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Dropout</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>LSTM</span><span class=p>(</span><span class=mi>64</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Dense</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;FC1&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Dropout</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Dense</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;out_layer&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>layer</span> <span class=o>=</span> <span class=n>Activation</span><span class=p>(</span><span class=s1>&#39;sigmoid&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Model</span><span class=p>(</span><span class=n>inputs</span><span class=o>=</span><span class=n>inputs</span><span class=p>,</span> <span class=n>outputs</span><span class=o>=</span><span class=n>layer</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>model</span>
</code></pre></td></tr></table></div></div><p>Here’s how we define it in our
<a href=/https://github.com/jackyzha0/reflect-nlp/blob/master/nlp/net.py rel=noopener>Keras code</a>, don’t worry if you don’t understand it just yet! We’ll explain it in the next few paragraphs.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>inputs</span> <span class=o>=</span> <span class=n>Input</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;inputs&#39;</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=n>max_seq_len</span><span class=p>])</span>
</code></pre></td></tr></table></div></div><p>Right off the bat, you’ll notice that the first layer is the Input layer. Basically, this tells Keras to instantiate a new tensor (a multi-dimensional vector) with a given shape. In this case, we’re creating a one-dimensional tensor that is max_seq_len units long. When we trained our model, this was set to 75.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>Embedding</span><span class=p>(</span><span class=n>vocab_size</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=n>input_length</span><span class=o>=</span><span class=n>max_seq_len</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Next up, we have the Embedding layer. We could get into a really technical discussion about what this really does, but you can think of it as a layer that helps the neural network to learn semantic relationships between inputs.</p><p><img src=https://cdn-images-1.medium.com/max/3010/0*YOZ_CfmtgpUbJ9BD alt="credit: Rutger Ruizendaal, 2017"><em>credit: Rutger Ruizendaal, 2017</em></p><p>Essentially, it embeds tokens in a higher dimension vector space, where distance between tokens represents its similarity.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>LSTM</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>return_sequences</span> <span class=o>=</span> <span class=bp>True</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Now, we get into the meat of the neural network: the LSTM layer. As stated before, these LSTM networks are really good at modelling time series data like language. In this case, our LSTM network has 64 hidden units per cell, and that we’d like to pass these hidden states to the next layer. If you’d like to learn more about the inner workings of the LSTM model, theres a really good resource
<a href=/https://towardsdatascience.com/illustrated-guide-to-lstms-and-gru-s-a-step-by-step-explanation-44e9eb85bf21 rel=noopener>here</a>!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>Dropout</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Next, you’ll notice there are a few Dropout layers. These layers help to prevent overfitting by randomly killing off connections between the two layers (a sort of regularization). This makes sure neurons aren’t just “memorizing” the input data. This is especially important because our dataset is relatively small (~2000 observations even after augmentation), so making sure that our machine learning model can generalize outside of this limited dataset is really important.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>LSTM</span><span class=p>(</span><span class=mi>64</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>We have yet another LSTM layer! By having these two chained right after each other, the first layer can pass all the values of all of its hidden states to the second layer, effectively allowing a sort of ‘deeper’ neural network.</p><p><img src=https://cdn-images-1.medium.com/max/2000/0*0BRdnA5sJBYbaeR9 alt="credit: Jianjing Zhang 2018"><em>credit: Jianjing Zhang 2018</em></p><p>This deep LSTM allows our network to learn more abstract concepts, making them well suited for natural language tasks.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>Dense</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;FC1&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Next, we have something called a Fully Connected layer, or a Dense layer. In a dense layer, each of the input neurons is connected to every output neuron. This kind of ‘glue’ layer helps the network to pick out and discriminate feature output by our previous LSTM layer.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>layer</span> <span class=o>=</span> <span class=n>Dense</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;out_layer&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
<span class=n>layer</span> <span class=o>=</span> <span class=n>Activation</span><span class=p>(</span><span class=s1>&#39;sigmoid&#39;</span><span class=p>)(</span><span class=n>layer</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Similarly, we have one final Dense layer that ‘compresses’ all of the hidden units down to one neuron. However, we want the output value of this neuron to be how confident from a scale of 0 to 1 it is that the intent is valid. We do this by applying something called an activation function.</p><p><img src=https://cdn-images-1.medium.com/max/2000/0*kdowh3GOGOUvGBr0 alt="A sigmoid activation function"></p><p>In this case, the particular function we chose is the sigmoid activation function, which looks something like the above.</p><h3 id=model-overview>Model Overview</h3><p>Phew, finally got through everything! After putting it all together, we end up with a network that looks something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># 75 max_seq_len</span>
<span class=c1># 1000 tokenizer_vocab_size</span>
<span class=n>model</span> <span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>RNN</span><span class=p>(</span><span class=mi>75</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span> 
<span class=n>model</span><span class=o>.</span><span class=n>summary</span><span class=p>()</span>

<span class=c1># _________________________________________________________________</span>
<span class=c1># Layer (type)                 Output Shape              Param #   </span>
<span class=c1># =================================================================</span>
<span class=c1># inputs (InputLayer)          (None, 75)                0         </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># embedding_1 (Embedding)      (None, 75, 64)            64000     </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># lstm_1 (LSTM)                (None, 75, 64)            33024     </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># dropout_1 (Dropout)          (None, 75, 64)            0         </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># lstm_2 (LSTM)                (None, 64)                33024     </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># FC1 (Dense)                  (None, 256)               16640     </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># dropout_2 (Dropout)          (None, 256)               0         </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># out_layer (Dense)            (None, 1)                 257       </span>
<span class=c1># _________________________________________________________________</span>
<span class=c1># activation_1 (Activation)    (None, 1)                 0         </span>
<span class=c1># =================================================================</span>
<span class=c1># Total params: 146,945</span>
<span class=c1># Trainable params: 146,945</span>
<span class=c1># Non-trainable params: 0</span>
<span class=c1># _________________________________________________________________</span>
</code></pre></td></tr></table></div></div><p>Theres a grand total of 150,000 different trainable knobs and parameters in our neural network!</p><h2 id=training-pipeline>Training pipeline</h2><p>So, how does the data we got earlier play a role in helping our machine learning model learn and improve?</p><p>The first component is the <strong>loss function.</strong> This component tells the neural network how ‘correct’ its prediction was. In this model, we will use something called
<a href=/https://towardsdatascience.com/understanding-binary-cross-entropy-log-loss-a-visual-explanation-a3ac6025181a rel=noopener>binary cross entropy</a>, which is basically a fancy word for log-based error. If the true label is 1, we can then show what the log-loss would be for some given prediction probability.</p><p><img src=https://cdn-images-1.medium.com/max/2000/0*8rd4ho_3Y6zrtra-.png alt></p><p>Next, we need to pick an <strong>optimizer</strong>. This component tells the neural network how to change its parameters to improve or ‘optimize’ itself. In this model, we chose to use an optimizer called
<a href=/https://towardsdatascience.com/understanding-rmsprop-faster-neural-network-learning-62e116fcf29a rel=noopener>RMSProp</a> with a learning rate of 1e-3 . We aren’t going to cover all the technical details of this optimizer in this blog post, but just know that it is a very fast and effective optimizer.</p><p><img src=https://cdn-images-1.medium.com/max/2000/0*HZM5XJ-quu276w39.gif alt="RMSProp(black) vs a bunch of other optimizers. credit: Vitaly Bushaev"><em>RMSProp(black) vs a bunch of other optimizers. credit: Vitaly Bushaev</em></p><p>One important hyperparameter we choose is the <strong>train-test split.</strong> In data science and machine learning, we typically withhold part of our data and set it aside as a <strong>test set</strong>. The rest of the data will be considered the <strong>training set.</strong> When training the model, we never feed it the test set. As a result, we can use the test set as a metric to see how well it would perform on real-world, unseen data. In our training, we used a train-test split of 20%.</p><p>Another important hyperparameter that we can choose is the <strong>mini-batch size</strong>. The mini-batch size determines how many training examples we feed the machine learning model before updating its parameters. A smaller mini-batch means that we get more frequent updates to the parameters, but it also runs the risk of having outliers that may cause a bad gradient update. A large mini-batch means that we get a more accurate gradient update but it also takes longer. A similar concept is <em>sample size</em> in statistics. We could pick a larger sample to get a better estimate of the overall population, but it is often more expensive to do so. A smaller sample might contain outliers and thus be less robust of an estimate of the overall population, but it very easy to do. So, there’s this tradeoff between accuracy and speed. We found that a good balance between these was a mini-batch size of 128.</p><p>We then trained our neural network over 10 epochs. A single epoch is one iteration over the entire dataset. If we train it for too many epochs, you run the risk of overfitting (memorizing the training data), but we don’t train it enough, we run the risk of not discovering a better model. One thing we can do it minimize this problem is through the use of cross-validation, which is a technique that lets us ‘test’ on portions of the training set. Essentially, at each iteration during training, we withhold a portion of the training set and use it as a sort of ‘validation’.</p><p><img src=https://cdn-images-1.medium.com/max/2000/0*6XoMgZUd3SxXgqBj.png alt="credit: Raheel Shaikh"><em>credit: Raheel Shaikh</em></p><p>By seeing when this validation accuracy goes down, we can get a pretty good idea of when our model begins to overfit on our data, and stop the training before this happens. In training our model, we will use 5-fold
<a href=/https://towardsdatascience.com/cross-validation-explained-evaluating-estimator-performance-e51e5430ff85 rel=noopener>cross-validation</a>.</p><p>After all of this, we end with a training accuracy of 93.60% and test accuracy of 85.95%. Not bad at all!</p><h2 id=serving-the-model>Serving the model</h2><p>Great! So now we have a trained model. Can we put that in the Chrome extension now? Not quite yet…</p><p>Our model was written and trained with Keras (a Python Deep Learning library). Our Chrome extension is written in TypeScript. How do we get these two to work together?</p><p>Luckily for us, Tensorflow.js exists! This library allows us to run Tensorflow models from within JavaScript. Tensorflow has released a script that lets us to convert a Keras model into something that Tensorflow.js understands, so we can run that to convert our models.</p><p>However, we can’t just directly plug-and-play. You may remember that we did all of that data preprocessing before we trained our model. Tensorflow.js doesn’t have any of this built in, so we made our own implementation of it. You can check it out
<a href=/https://github.com/jackyzha0/reflect-chrome/blob/master/src/nn.ts rel=noopener>here</a>.</p><p>We’ll leave all the technical code out (if you’re interested, feel free to peek around the source code!), but we’ve abstracted it enough that classifying an intent is a breeze.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-typescript data-lang=typescript><span class=c1>// declared somewhere earlier
</span><span class=c1></span><span class=kr>const</span> <span class=nx>model</span>: <span class=kt>nn.IntentClassifier</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>nn</span><span class=p>.</span><span class=nx>IntentClassifier</span><span class=p>(</span><span class=s2>&#34;acc85.95&#34;</span><span class=p>);</span> <span class=c1>// name of converted model
</span><span class=c1></span>
<span class=c1>// send to nlp model for prediction
</span><span class=c1></span><span class=kr>const</span> <span class=nx>valid</span>: <span class=kt>boolean</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>model</span><span class=p>.</span><span class=nx>predict</span><span class=p>(</span><span class=nx>intent</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>valid</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// let through
</span><span class=c1></span><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// block page
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=future-improvement>Future improvement</h2><h3 id=possible-models>Possible models</h3><p>We have thought about using something more established and complex like
<a href=/https://arxiv.org/abs/1810.04805 rel=noopener>BERT</a> and retraining it on our dataset, however then comes the problem of runtime and memory usage.</p><p>BERT is a huge model. If you thought 150 thousand parameters was a lot, wait till you see BERT’s 110 <em>million</em> parameters. This bad boy takes a few hundred times longer and many times more memory than our current model. While yes BERT may perform really well, we just don’t think it has a place inside of a Chrome extension.</p><p>Our model is decently robust as it is, especially considering the entire model is &lt;2MB and takes less than 200ms to run in browser. For now, we will stick with lightweight models, but we may switch if we find a better match in the future :)</p><h3 id=misclassifications>Misclassifications</h3><p>Of course, this algorithm isn’t perfect. It does have a lot of flaws and weaknesses that we find every day, and we’re working to fix those! If there are any misclassifications that you find in the algorithm, we love to hear about it on our feedback form:
<a href=/https://forms.gle/ctypb6FmDT9RQqjv6 rel=noopener>https://forms.gle/ctypb6FmDT9RQqjv6</a>.</p><h2 id=closing>Closing</h2><p>This NLP model is at the core of reflect. It is this model’s goal to predict whether user intents are valid or not. As a result, we need to make sure this algorithm is accurate, fast, and lightweight. Hopefully, through this blog post, you’ve learned a little about how we went about building a model to fulfill those requirements.</p><p>Learn more about us on our website! ✨
<a href=/http://getreflect.app/ rel=noopener>http://getreflect.app/</a></p><p>If you have any further questions about reflect or this NLP model, feel free to shoot us an email at <a href=mailto:hello@getreflect.app>hello@getreflect.app</a></p></div><div><hr><div class=morePosts><a class=postLink href="https://jzhao.xyz/posts/docker/?ref=footer">← Docker Explained</a>
<a class="postLink next" href="https://jzhao.xyz/posts/hootsuite/?ref=footer">Interning at Hootsuite in Highschool →</a></div><article><p>I'm always happy to have follow up conversations or hear your thoughts! Shoot me an email at <a href=mailto:j.zhao2k19@gmail.com>j.zhao2k19@gmail.com</a> or <a href=https://twitter.com/_jzhao>yell at me on Twitter</a>.</p><p>If you like this content and want to keep up to
date with my latest ramblings and whatever else I've found interesting on the web, you should consider subscribing to my
newsletter :) Not convinced yet? Read some <a href=/newsletters>previous issues here</a>!</p><form id=newsletter action=https://buttondown.email/api/emails/embed-subscribe/jacky method=post target=popupwindow onsubmit="window.open('https://buttondown.email/jacky','popupwindow')" class=embeddable-buttondown-form><input type=email placeholder=name@email.com name=email id=bd-email>
<input type=hidden value=1 name=embed>
<input type=submit value=Subscribe></form></article><a href=/posts>← (country roads) take me home</a></div></article><footer><footer><p>made by Jacky Zhao, © 2021</p><a href=/>home</a>
<a href=https://github.com/jackyzha0/jackyzha0.github.io>source</a><a href=https://twitter.com/_jzhao>twitter</a></footer></footer></div><script>const toggleSwitch=document.querySelector('#darkmode-toggle')
const userPref=window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'
const currentTheme=localStorage.getItem('theme')??userPref
if(currentTheme){document.documentElement.setAttribute('saved-theme',currentTheme);if(currentTheme==='dark'){toggleSwitch.checked=true}}
const switchTheme=(e)=>{if(e.target.checked){document.documentElement.setAttribute('saved-theme','dark')
localStorage.setItem('theme','dark')}
else{document.documentElement.setAttribute('saved-theme','light')
localStorage.setItem('theme','light')}}
toggleSwitch.addEventListener('change',switchTheme,false)</script></body></html>