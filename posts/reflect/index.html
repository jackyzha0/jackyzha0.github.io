<!DOCTYPE html>
<html lang="en">



<head>
  
  <meta charset="UTF-8" />
  <meta
    name="description"
    content="How do we tell that this is a “valid” intent?
A (not so) brief exploration of how we tackle classifying intents in reflect."
  />
  <title>
    reflect: NLP Model Explained
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <meta property="og:url" content="https://jzhao.xyz" />
  <meta property="og:title" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="https://jzhao.xyz/res/og-card.png" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@_jzhao">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="https://jzhao.xyz/res/og-card.png" />


  
  
  
  
  
  <link rel="shortcut icon" type="image/png"  href="https://jzhao.xyz//icon.png" />
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <link href="https://jzhao.xyz/styles.e31d5446645b0874bef4b0dafebf9f04.min.css" rel="stylesheet" />

  
  <link href="https://jzhao.xyz/styles/_light_syntax.32359fa0e4ad5c5b354cb209e7fa1b22.min.css" rel="stylesheet" id="theme-link">

   
  
  
  
  
  <script src="https://jzhao.xyz/js/darkmode.182a2b4c9451f6f751c276a71c985624.min.js"></script>
  
  
  
  <script src="https://jzhao.xyz/js/util.e48d3a3640b20984a244ec38e7d97219.min.js"></script>
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js" integrity="sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A" crossorigin="anonymous"></script>



  
  


    
  <script src="https://unpkg.com/@floating-ui/core@0.7.3"></script>
  <script src="https://unpkg.com/@floating-ui/dom@0.5.4"></script>
  
  <script src="https://jzhao.xyz/js/popover.6da9b273c092cc16fc1aa904d71a2163.min.js"></script>

  
  
  
  <script src="https://jzhao.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js"></script>
  

  
  
  <script src="https://jzhao.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js"></script>
  

  

  
   
  <script>
    
    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const lastVisit = localStorage.getItem('lastVisitTime')
    const now = Date.now()
    let show = 'true'
    if (lastVisit) {
      document.documentElement.setAttribute('visited', 'true')
      const minElapsed = Math.ceil((now - parseInt(lastVisit)) / (1000 * 60))
      show = (!isReducedMotion && minElapsed > 5) ? 'true' : 'false'
    }
    document.documentElement.setAttribute('show-animation', show)
    localStorage.setItem('lastVisitTime', `${now}`)

    const SEARCH_ENABLED =  true 
    const LATEX_ENABLED =  true 
    const PRODUCTION =  true 
    const BASE_URL = "https://jzhao.xyz/"
    const fetchData = Promise.all([
          fetch("https:\/\/jzhao.xyz\/indices\/linkIndex.9fe76560798ca9b98a9bfd1609231457.min.json")
            .then(data => data.json())
            .then(data => ({
              index: data.index,
              links: data.links,
            })),
          fetch("https:\/\/jzhao.xyz\/indices\/contentIndex.9a260f55def14ad668c4a79252d8f7a7.min.json")
            .then(data => data.json()),
        ])
        .then(([{index, links}, content]) => ({
          index,
          links,
          content,
        }))

      const render = () => {
      

      const siteBaseURL = new URL(BASE_URL);
      const pathBase = siteBaseURL.pathname;
      const pathWindow = window.location.pathname;
      const isHome = pathBase == pathWindow;

      addCopyButtons();
      

      addTitleToCodeBlocks();
      

      
     
      
      initPopover(
        "https://jzhao.xyz",
         true 

      )
      

      
      const footer = document.getElementById("footer")
      if (footer) {
        const container = document.getElementById("graph-container")
        
        if (!container) return requestAnimationFrame(render)
        
        container.textContent = ""

        const drawGlobal = isHome &&  false ;
        drawGraph(
            "https://jzhao.xyz",
            drawGlobal,
            [{"/moc":"#4388cc"}],
            drawGlobal ? {"centerForce":1,"depth":-1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.5,"linkDistance":1,"opacityScale":3,"repelForce":1,"scale":1.4} : {"centerForce":1,"depth":1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.6,"linkDistance":0.8,"opacityScale":3,"repelForce":2,"scale":1}
          );

        }
      

      
        var els = document.getElementsByClassName("mermaid");
        if (els.length > 0) {
          import('https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs').then(
            (obj) => {
              
              
              obj.default.init();
            }
          )
        }
      
    }

    const init = (doc = document) => {
      
      addCopyButtons();
      

      addTitleToCodeBlocks();
      renderMathInElement(doc.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
        ],
        macros: {
          '’': "'"
        },
        throwOnError : false
      });
      
    };
  </script>
  
  
  <script type="module">
    import { attachSPARouting } from "https:\/\/jzhao.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script>
  
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-WDD4K02HML"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-WDD4K02HML', { 'anonymize_ip': false });
}
</script>



<body>
<div id="search-container">
  <div id="search-space">
    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search"
      placeholder="Search for something..." dir="">
    <div id="results-container">
    </div>
  </div>
</div>


<script defer type="module" src="https://jzhao.xyz/js/semantic-search.928ff7841d5bd97b1043546587762cf5.min.js"></script>



<div id="cursor-chat-layer">
  <input type="text" id="cursor-chat-box">
</div>
<script type="module">
  import { initCursorChat } from 'https://esm.sh/cursor-chat'
  initCursorChat("jzhao.xyz")
</script>

<div class="singlePage">
    
    <header class="delay t-3">
    <h1 id="page-title"><a href="https://jzhao.xyz/">jzhao.xyz</a></h1>
    <div class="spacer"></div>
    <div id="search-icon">
      <p>Search</p>
      <svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg>
    </div>
    <div class='darkmode'>
    <input class='toggle' id='darkmode-toggle' type='checkbox' tabindex="-1">
    <label id="toggle-label-light" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve">
            <title>Light Mode</title>
            <path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z" />
        </svg>
    </label>
    <label id="toggle-label-dark" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xml:space="preserve">
            <title>Dark Mode</title>
            <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z" />
        </svg>
    </label>
</div>

</header>


    <article>
      <h1>reflect: NLP Model Explained</h1>
      <p class="meta">
        Last updated 
May 10, 2020

 
          
<a href="https://github.com/jackyzha0/quartz/tree/hugo/content/posts/reflect.md" rel="noopener">Edit Source</a>


      </p>
      <ul class="tags">
    
    <li><a href="https://jzhao.xyz/tags/technical/">Technical</a></li>
    
    <li><a href="https://jzhao.xyz/tags/fruit/">Fruit</a></li>
    
</ul>

      


      














  
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  












<p>

<img src="https://miro.medium.com/max/1400/1*yjCs2Mmcve8wNI1pdfXelw.png" width="auto" alt="An image of the reflect block page"  /><em>How do we tell that this is a “valid” intent?</em></p>
<p>A (not so) brief exploration of how we tackle classifying intents in reflect. Part 1 will touch on defining the problem we’re trying to solve, the data we have, and how we pre-processed it. Part 2 will focus on the architecture of the model we built, how well it does, and thoughts on improving it for the future.</p>
<a href="#the-problem"><h2 id="the-problem"><span class="hanchor" ariaLabel="Anchor"># </span>The problem</h2></a>
<p>Classifying intents is at the core of reflect. When a user inputs an intent, its reflect’s job to figure out whether that intent should let them into the website.</p>
<blockquote>
<p>How do we make sure “do some marketing work for reflect” is classified as productive but “watch cute dog videos” isn’t?</p>
</blockquote>
<a href="#why-its-so-difficult"><h2 id="why-its-so-difficult"><span class="hanchor" ariaLabel="Anchor"># </span>Why it’s so difficult</h2></a>
<p>A lot of it comes down to the fact that natural language processing (<a href="/thoughts/NLP" rel="noopener" class="internal-link" data-src="/thoughts/NLP">NLP</a>) is a very difficult task. What does the sentence “learn about physics” mean, and how is it semantically different from “asdflkj I can’t do work”?</p>
<p>We can’t just parse for keywords and just allow a user in if we see the word “work” because that word can mean different things in different contexts. For example, “I’m not doing any work right now” would have otherwise been classified as valid. Thus, we can employ the help of a machine learning algorithm to help us capture this deeper meaning.</p>
<p>Specifically, the form of machine learning we will be using is called <strong>supervised learning,</strong> in which we give an algorithm a bunch of labelled data, tell it what it’s doing wrong, and let it ‘learn.’ Through doing this, hopefully the algorithm will be able to generalize and make predictions on unseen data too.</p>
<a href="#the-data"><h2 id="the-data"><span class="hanchor" ariaLabel="Anchor"># </span>The data</h2></a>
<p>Of course, if we want to perform supervised learning, we’re going to need a lot of data. Where are we going to get all of it? Luckily, we were able to get it through 3 different sources.</p>
<a href="#survey-data-444-entries"><h3 id="survey-data-444-entries"><span class="hanchor" ariaLabel="Anchor"># </span>Survey data (444 entries)</h3></a>
<p>Our team sent out an interest survey in early January in which we asked 3 questions:</p>
<ol>
<li>
<p>How would you answer if you were trying to visit a distracting site while trying to focus? (eg. youtube, facebook, etc)</p>
</li>
<li>
<p>How would you answer if you were trying to visit a distracting site to take a quick break from your work? (eg. youtube, facebook, etc)</p>
</li>
<li>
<p>How would you answer if you were trying to visit a distracting site like Facebook but to do work? (e.g. make a marketing post)</p>
</li>
</ol>
<p>We used these answers to form the basis of our very first dataset. We ended up getting a surprising amount of entries, ending with 148 responses to 3 questions and totalling 444 different observations. Here’s what some of that data looks like after tidying it up:</p>
<blockquote>
<p>We classified any answer to Q1 as invalid and Q2 + Q3 as valid</p>
</blockquote>
<table>
<thead>
<tr>
<th>intent</th>
<th>valid</th>
</tr>
</thead>
<tbody>
<tr>
<td>I am watching a 5 minute video to take my mind off not being productive :/</td>
<td>no</td>
</tr>
<tr>
<td>I&rsquo;m just bored</td>
<td>no</td>
</tr>
<tr>
<td>I’m bored/tired and trying to relax</td>
<td>no</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
<tr>
<td>work is pretty boring, i need to take a quick break I just can&rsquo;t focus atm</td>
<td>yes</td>
</tr>
<tr>
<td>I finished all my work for today so I&rsquo;m going to take a break now!</td>
<td>yes</td>
</tr>
<tr>
<td>getting some advertising done for my club</td>
<td>yes</td>
</tr>
<tr>
<td>I need to make a post on Twitter for my job announcing the latest update to our site</td>
<td>yes</td>
</tr>
<tr>
<td>I&rsquo;m trying to network</td>
<td>yes</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<a href="#closed-beta-790-entries"><h3 id="closed-beta-790-entries"><span class="hanchor" ariaLabel="Anchor"># </span>Closed Beta (790 entries)</h3></a>
<p>After we made a basic dataset, we were able to make our first (admittedly not great) model. But in doing so, this let us create an MVP to which we could use to actually test with. We then deployed this model for use to our closed beta testers and collected their responses (with consent of course!) along with the website it was input on. This was then converted into a .csv file. A few examples are show below:</p>
<table>
<thead>
<tr>
<th>intent</th>
<th>url</th>
</tr>
</thead>
<tbody>
<tr>
<td>to do some marketing</td>
<td>facebook.com/</td>
</tr>
<tr>
<td>i cannot focus on my work</td>
<td>instagram.com/</td>
</tr>
<tr>
<td>fuel my crippling social media addiction</td>
<td>facebook.com/</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>These were then hand-labelled by our reflect team in a similar format as the survey data we collected earlier.</p>
<table>
<thead>
<tr>
<th>intent</th>
<th>valid</th>
</tr>
</thead>
<tbody>
<tr>
<td>to do some marketing</td>
<td>yes</td>
</tr>
<tr>
<td>i cannot focus on my work</td>
<td>no</td>
</tr>
<tr>
<td>fuel my crippling social media addiction</td>
<td>no</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<a href="#closed-beta-corrections-37-entries"><h3 id="closed-beta-corrections-37-entries"><span class="hanchor" ariaLabel="Anchor"># </span>Closed Beta Corrections (37 entries)</h3></a>
<p>Finally, we created a Google Forms through which we directly asked beta testers if a decision made by reflect’s intent classifier was faulty. Specifically, we asked what they input, and what they expected. Here are a few examples:</p>
<table>
<thead>
<tr>
<th>input</th>
<th>valid</th>
</tr>
</thead>
<tbody>
<tr>
<td>reply to a friend about a lab</td>
<td>yes</td>
</tr>
<tr>
<td>listening to a youtube music playlist</td>
<td>yes</td>
</tr>
<tr>
<td>goof off as much as possible</td>
<td>yes</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>This entire section of the dataset was only 37 observations, but it drastically helped us reduce false positives and false negatives by focusing specifically on misclassifications.</p>
<p>After aggregating and combing all our data into one common format, we ended up with a grand total of 1271 observations. They looked something like this:</p>
<table>
<thead>
<tr>
<th>input</th>
<th>expected</th>
</tr>
</thead>
<tbody>
<tr>
<td>fail school by watching youtube</td>
<td>no</td>
</tr>
<tr>
<td>sdlkjasd</td>
<td>no</td>
</tr>
<tr>
<td>making a quick product post (should take &lt;10 min)</td>
<td>yes</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<a href="#so"><h3 id="so"><span class="hanchor" ariaLabel="Anchor"># </span>So?</h3></a>
<p>Now that we have the data, can we just throw it into a machine learning model? Unfortunately, the answer is no, not quite yet.</p>
<a href="#data-augmentation"><h2 id="data-augmentation"><span class="hanchor" ariaLabel="Anchor"># </span>Data augmentation</h2></a>
<p>Our dataset is still pretty small, even after aggregating all of our data. It most definitely doesn’t cover all of our bases for all the possible things that future users could possibly input. So, how can we “upsample” our data to get more of it? Well, it turns out that the field of Natural Language Processing has quite a few tricks to augment our data.</p>
<a href="#sentence-variation"><h3 id="sentence-variation"><span class="hanchor" ariaLabel="Anchor"># </span>Sentence Variation</h3></a>
<p>Essentially what sentence variation is, is just replacing a few words of given sentences with their synonyms. If we have a sentence like “I’m trying to make a marketing post,” we can swap out singular words with their synonyms and tell our network that it means the same thing.</p>
<p>In this example, we could get something like “I’m attempting to fabricate a marketing post”. Adding these additional sentence variations will allow our machine learning model to learn semantic relationships between similar words (e.g. fabricate and make have similar meaning)</p>
<a href="#sentence-negation"><h3 id="sentence-negation"><span class="hanchor" ariaLabel="Anchor"># </span>Sentence Negation</h3></a>
<p>Additionally, if we add a ‘not’ in the sentence, it should flip the meaning of the sentence. An example would be “learning about physics” is valid, whereas “not learning about physics” is not. However, if the sentence already contains ‘not’ (e.g. “I’m not being productive”), adding another ‘not’ would make the sentence too complex and obfuscated, so we just label it as invalid. In essence, we just add ‘not’ to a bunch of sentences and label them as invalid. This helps us to combat intents which use negations in a sort of round-a-bout way to confuse the algorithm.</p>
<a href="#shuffled-sentences"><h3 id="shuffled-sentences"><span class="hanchor" ariaLabel="Anchor"># </span>Shuffled Sentences</h3></a>
<p>If we take an existing, valid sentence and completely shuffle the words, the resulting sentence should be invalid. An example would be “to watch a crash course video*” should be valid whereas “video course a watch crash to*” should be invalid. Basically, we’re just shuffling existing sentences and also labelling them as invalid. This helps us to combat intents which grammatically make no sense, but are otherwise valid.</p>
<a href="#garbage-sentences"><h3 id="garbage-sentences"><span class="hanchor" ariaLabel="Anchor"># </span>Garbage Sentences</h3></a>
<p>We can also take completely random words from the English language and put them together. The resulting sentences should all be invalid. For example, “*untinkered phalangitis shaly quinovic dish spadiciflorous unshaved” *clearly makes no sense. However, the addition of these gibberish sentences allows our model to be more robust against foreign words and out-of-vocabulary terms.</p>
<a href="#vocabulary-mix-sentences"><h3 id="vocabulary-mix-sentences"><span class="hanchor" ariaLabel="Anchor"># </span>Vocabulary-mix Sentences</h3></a>
<p>Last but definitely not least, we can take the most common words in our dataset and mash them together. This should yield us a bunch of sentences which contain “key words” but should be marked as invalid because the context in which they are used makes no sense. For example, “video look watching” and “get research facebook take need want need message watch” are both clearly gibberish sentences, but they have a lot of keywords that one would think would let you in (e.g. video, research, watching, etc.). This lets us be more robust against those who try to get around the algorithm using keywords.</p>
<a href="#data-preprocessing"><h2 id="data-preprocessing"><span class="hanchor" ariaLabel="Anchor"># </span>Data preprocessing</h2></a>
<p>What about now? Can we throw it into the neural network yet? Well, no. We may have increased the amount of data we have to work with, but we also need to convert it to a form that is easy to understand for both the computer and for our algorithm. We do that with a series of functions that we apply on our data.</p>
<a href="#strip-punctuation"><h3 id="strip-punctuation"><span class="hanchor" ariaLabel="Anchor"># </span>Strip punctuation</h3></a>
<p>As the name suggests, we remove all punctuation from the input phrase. We found that including the punctuation hurt our performance, most likely due to the fact that they offer very little in terms of semantic meaning and obfuscate the real meaning of the sentence.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">stripPunctuation</span><span class="p">(</span><span class="s2">&#34;I don&#39;t know if I&#39;m being productive! :(&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="s2">&#34;I dont know if Im being productive&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#make-everything-lowercase"><h3 id="make-everything-lowercase"><span class="hanchor" ariaLabel="Anchor"># </span>Make everything lowercase</h3></a>
<p>Additionally, we found that in this particular setting, capital letters also didn’t matter that much. Because of the nature we collect our data (just a simple textbox), users tend to not bother with capitalization. As such, we remove it to make it consistent across our data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">lower</span><span class="p">(</span><span class="s2">&#34;I dont know if Im being productive&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="s2">&#34;i dont know if im being productive&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#expand-contractions"><h3 id="expand-contractions"><span class="hanchor" ariaLabel="Anchor"># </span>Expand contractions</h3></a>
<p>The English language does this weird thing where we can just smush two words together (e.g. “I am” to “I’m”). Unfortunately for us, these produce extra complexity in our model that we could reduce by making them all consistent. In our case, we chose to expand all of these contractions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">expandContractions</span><span class="p">(</span><span class="s2">&#34;i dont know if im being productive&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="s2">&#34;i do not know if i am being productive&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#remove-stop-words"><h3 id="remove-stop-words"><span class="hanchor" ariaLabel="Anchor"># </span>Remove stop words</h3></a>
<p>The English language also has a bunch of these things called <strong>stop words</strong> — words that do not contribute anything major to the sentence in terms of semantic understanding (usually in the context of natural language tasks such as this). A few examples of them are ‘I’, ‘me’, ‘my’, ‘by’, and ‘on’. By removing them, we once again remove unneeded complexity from the model.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">rmStopwords</span><span class="p">(</span><span class="s2">&#34;i do not know if i am being productive&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="s2">&#34;not know productive&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#tokenization"><h3 id="tokenization"><span class="hanchor" ariaLabel="Anchor"># </span>Tokenization</h3></a>
<p>However, these words are not super friendly for machine learning algorithms who would much rather deal with integers and floating point numbers than words and sentences. How do we fix this?</p>
<p>Well, one thing we can do is turn words in indices by how often they appear, capped at the most common 1000 words — in essence, creating a vocabulary list mapping common words to numbers. For example, if “the” is the most common word, we convert it to 1. If “work” is the 8th most common word, we convert it to 8. For anything that isn’t in the top 1000, we give it the value of 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tokenize</span><span class="p">(</span><span class="s2">&#34;not know productive&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#fixed-sequence-length"><h3 id="fixed-sequence-length"><span class="hanchor" ariaLabel="Anchor"># </span>Fixed sequence length</h3></a>
<p>Finally, we need to ensure that all the inputs are the same length of simplicity sake. If we were to handle dynamic length inputs, it would introduce a whole other level of complexity that we’re really not ready to deal with. As such, we can make sure all the inputs are the same length by adding a bunch of zeros to those who are too short (zero padding) or by slicing those who are too long.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pad</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#finally"><h3 id="finally"><span class="hanchor" ariaLabel="Anchor"># </span>Finally</h3></a>
<p>After all of these functions have been applied, we have successfully converted a complex sentence into a series of ‘tokens’ that is easy to understand for the machine learning algorithm.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preprocess</span><span class="p">(</span><span class="s2">&#34;I don’t know if I’m being productive! :(&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#whats-next"><h2 id="whats-next"><span class="hanchor" ariaLabel="Anchor"># </span>What’s next?</h2></a>
<p>Now that we have something ready to feed into our neural network, let’s dive into how the actual model itself works! How do we tell that this is a “valid” intent?</p>
<a href="#the-model"><h2 id="the-model"><span class="hanchor" ariaLabel="Anchor"># </span>The model</h2></a>
<p>The type of neural network that we’ll be using is called Long Short-Term Memory (<a href="/thoughts/LSTM" rel="noopener" class="internal-link" data-src="/thoughts/LSTM">LSTM</a>).</p>
<p>

<img src="https://cdn-images-1.medium.com/max/4000/0*HyoZq6fOfsnn2YOC" width="auto" alt="credit: Christopher Olah, 2015"  /><em>credit: Christopher Olah, 2015</em></p>
<p>What’s so special about these networks is that they are really good at modelling time-series data, making it an ideal candidate for tasks like forecasting or natural language processing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Function to create a RNN model with given parameters</span>
</span></span><span class="line"><span class="cl"><span class="c1"># max_seq_len: maximum token sequence length</span>
</span></span><span class="line"><span class="cl"><span class="c1"># vocab_size:  size of tokenizer vocabulary</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">RNN</span><span class="p">(</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">max_seq_len</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">input_length</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FC1&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_layer&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">layer</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">model</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here’s how we define it in our 
<a href="https://github.com/jackyzha0/reflect-nlp/blob/master/nlp/net.py" rel="noopener">Keras code</a>, don’t worry if you don’t understand it just yet! We’ll explain it in the next few paragraphs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">max_seq_len</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Right off the bat, you’ll notice that the first layer is the Input layer. Basically, this tells Keras to instantiate a new tensor (a multi-dimensional vector) with a given shape. In this case, we’re creating a one-dimensional tensor that is max_seq_len units long. When we trained our model, this was set to 75.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">input_length</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next up, we have the Embedding layer. We could get into a really technical discussion about what this really does, but you can think of it as a layer that helps the neural network to learn semantic relationships between inputs.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/3010/0*YOZ_CfmtgpUbJ9BD" width="auto" alt="credit: Rutger Ruizendaal, 2017"  /><em>credit: Rutger Ruizendaal, 2017</em></p>
<p>Essentially, it embeds tokens in a <a href="/thoughts/latent-factor-model" rel="noopener" class="internal-link" data-src="/thoughts/latent-factor-model">higher dimension vector space</a>, where distance between tokens represents its similarity.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we get into the meat of the neural network: the LSTM layer. As stated before, these LSTM networks are really good at modelling time series data like language. In this case, our LSTM network has 64 hidden units per cell, and that we’d like to pass these hidden states to the next layer. If you’d like to learn more about the inner workings of the LSTM model, theres a really good resource 
<a href="https://towardsdatascience.com/illustrated-guide-to-lstms-and-gru-s-a-step-by-step-explanation-44e9eb85bf21" rel="noopener">here</a>!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, you’ll notice there are a few Dropout layers. These layers help to prevent overfitting by randomly killing off connections between the two layers (a sort of regularization). This makes sure neurons aren’t just “memorizing” the input data. This is especially important because our dataset is relatively small (~2000 observations even after augmentation), so making sure that our machine learning model can generalize outside of this limited dataset is really important.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have yet another LSTM layer! By having these two chained right after each other, the first layer can pass all the values of all of its hidden states to the second layer, effectively allowing a sort of ‘deeper’ neural network.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/2000/0*0BRdnA5sJBYbaeR9" width="auto" alt="credit: Jianjing Zhang 2018"  /><em>credit: Jianjing Zhang 2018</em></p>
<p>This deep LSTM allows our network to learn more abstract concepts, making them well suited for natural language tasks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FC1&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we have something called a Fully Connected layer, or a Dense layer. In a dense layer, each of the input neurons is connected to every output neuron. This kind of ‘glue’ layer helps the network to pick out and discriminate feature output by our previous LSTM layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_layer&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">layer</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly, we have one final Dense layer that ‘compresses’ all of the hidden units down to one neuron. However, we want the output value of this neuron to be how confident from a scale of 0 to 1 it is that the intent is valid. We do this by applying something called an activation function.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/2000/0*kdowh3GOGOUvGBr0" width="auto" alt="A sigmoid activation function"  /></p>
<p>In this case, the particular function we chose is the sigmoid activation function, which looks something like the above.</p>
<a href="#model-overview"><h3 id="model-overview"><span class="hanchor" ariaLabel="Anchor"># </span>Model Overview</h3></a>
<p>Phew, finally got through everything! After putting it all together, we end up with a network that looks something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 75 max_seq_len</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1000 tokenizer_vocab_size</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Layer (type)                 Output Shape              Param #   </span>
</span></span><span class="line"><span class="cl"><span class="c1"># =================================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1"># inputs (InputLayer)          (None, 75)                0         </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># embedding_1 (Embedding)      (None, 75, 64)            64000     </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lstm_1 (LSTM)                (None, 75, 64)            33024     </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dropout_1 (Dropout)          (None, 75, 64)            0         </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lstm_2 (LSTM)                (None, 64)                33024     </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># FC1 (Dense)                  (None, 256)               16640     </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dropout_2 (Dropout)          (None, 256)               0         </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># out_layer (Dense)            (None, 1)                 257       </span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span><span class="line"><span class="cl"><span class="c1"># activation_1 (Activation)    (None, 1)                 0         </span>
</span></span><span class="line"><span class="cl"><span class="c1"># =================================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Total params: 146,945</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Trainable params: 146,945</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Non-trainable params: 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># _________________________________________________________________</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Theres a grand total of 150,000 different trainable knobs and parameters in our neural network!</p>
<a href="#training-pipeline"><h2 id="training-pipeline"><span class="hanchor" ariaLabel="Anchor"># </span>Training pipeline</h2></a>
<p>So, how does the data we got earlier play a role in helping our machine learning model learn and improve?</p>
<p>The first component is the <strong>loss function.</strong> This component tells the neural network how ‘correct’ its prediction was. In this model, we will use something called 
<a href="https://towardsdatascience.com/understanding-binary-cross-entropy-log-loss-a-visual-explanation-a3ac6025181a" rel="noopener">binary cross entropy</a>, which is basically a fancy word for log-based error. If the true label is 1, we can then show what the log-loss would be for some given prediction probability.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/2000/0*8rd4ho_3Y6zrtra-.png" width="auto" alt=""  /></p>
<p>Next, we need to pick an <strong>optimizer</strong>. This component tells the neural network how to change its parameters to improve or ‘optimize’ itself. In this model, we chose to use an optimizer called 
<a href="https://towardsdatascience.com/understanding-rmsprop-faster-neural-network-learning-62e116fcf29a" rel="noopener">RMSProp</a> with a learning rate of 1e-3 . We aren’t going to cover all the technical details of this optimizer in this blog post, but just know that it is a very fast and effective optimizer.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/2000/0*HZM5XJ-quu276w39.gif" width="auto" alt="RMSProp(black) vs a bunch of other optimizers. credit: Vitaly Bushaev"  /><em>RMSProp(black) vs a bunch of other optimizers. credit: Vitaly Bushaev</em></p>
<p>One important hyperparameter we choose is the <strong>train-test split.</strong> In data science and machine learning, we typically withhold part of our data and set it aside as a <strong>test set</strong>. The rest of the data will be considered the <strong>training set.</strong> When training the model, we never feed it the test set. As a result, we can use the test set as a metric to see how well it would perform on real-world, unseen data. In our training, we used a train-test split of 20%.</p>
<p>Another important hyperparameter that we can choose is the <strong>mini-batch size</strong>. The mini-batch size determines how many training examples we feed the machine learning model before updating its parameters. A smaller mini-batch means that we get more frequent updates to the parameters, but it also runs the risk of having outliers that may cause a bad gradient update. A large mini-batch means that we get a more accurate gradient update but it also takes longer. A similar concept is <em>sample size</em> in statistics. We could pick a larger sample to get a better estimate of the overall population, but it is often more expensive to do so. A smaller sample might contain outliers and thus be less robust of an estimate of the overall population, but it very easy to do. So, there’s this tradeoff between accuracy and speed. We found that a good balance between these was a mini-batch size of 128.</p>
<p>We then trained our neural network over 10 epochs. A single epoch is one iteration over the entire dataset. If we train it for too many epochs, you run the risk of overfitting (memorizing the training data), but we don’t train it enough, we run the risk of not discovering a better model. One thing we can do it minimize this problem is through the use of cross-validation, which is a technique that lets us ‘test’ on portions of the training set. Essentially, at each iteration during training, we withhold a portion of the training set and use it as a sort of ‘validation’.</p>
<p>

<img src="https://cdn-images-1.medium.com/max/2000/0*6XoMgZUd3SxXgqBj.png" width="auto" alt="credit: Raheel Shaikh"  /><em>credit: Raheel Shaikh</em></p>
<p>By seeing when this validation accuracy goes down, we can get a pretty good idea of when our model begins to overfit on our data, and stop the training before this happens. In training our model, we will use 5-fold 
<a href="https://towardsdatascience.com/cross-validation-explained-evaluating-estimator-performance-e51e5430ff85" rel="noopener">cross-validation</a>.</p>
<p>After all of this, we end with a training accuracy of 93.60% and test accuracy of 85.95%. Not bad at all!</p>
<a href="#serving-the-model"><h2 id="serving-the-model"><span class="hanchor" ariaLabel="Anchor"># </span>Serving the model</h2></a>
<p>Great! So now we have a trained model. Can we put that in the Chrome extension now? Not quite yet…</p>
<p>Our model was written and trained with Keras (a Python Deep Learning library). Our Chrome extension is written in TypeScript. How do we get these two to work together?</p>
<p>Luckily for us, Tensorflow.js exists! This library allows us to run Tensorflow models from within JavaScript. Tensorflow has released a script that lets us to convert a Keras model into something that Tensorflow.js understands, so we can run that to convert our models.</p>
<p>However, we can’t just directly plug-and-play. You may remember that we did all of that data preprocessing before we trained our model. Tensorflow.js doesn’t have any of this built in, so we made our own implementation of it. You can check it out 
<a href="https://github.com/jackyzha0/reflect-chrome/blob/master/src/nn.ts" rel="noopener">here</a>.</p>
<p>We’ll leave all the technical code out (if you’re interested, feel free to peek around the source code!), but we’ve abstracted it enough that classifying an intent is a breeze.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// declared somewhere earlier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">model</span>: <span class="kt">nn.IntentClassifier</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">nn</span><span class="p">.</span><span class="nx">IntentClassifier</span><span class="p">(</span><span class="s2">&#34;acc85.95&#34;</span><span class="p">);</span> <span class="c1">// name of converted model
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// send to nlp model for prediction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">valid</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">model</span><span class="p">.</span><span class="nx">predict</span><span class="p">(</span><span class="nx">intent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// let through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// block page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a href="#future-improvement"><h2 id="future-improvement"><span class="hanchor" ariaLabel="Anchor"># </span>Future improvement</h2></a>
<a href="#possible-models"><h3 id="possible-models"><span class="hanchor" ariaLabel="Anchor"># </span>Possible models</h3></a>
<p>We have thought about using something more established and complex like 
<a href="https://arxiv.org/abs/1810.04805" rel="noopener">BERT</a> and retraining it on our dataset, however then comes the problem of runtime and memory usage.</p>
<p>BERT is a huge model. If you thought 150 thousand parameters was a lot, wait till you see BERT’s 110 <em>million</em> parameters. This bad boy takes a few hundred times longer and many times more memory than our current model. While yes BERT may perform really well, we just don’t think it has a place inside of a Chrome extension.</p>
<p>Our model is decently robust as it is, especially considering the entire model is &lt;2MB and takes less than 200ms to run in browser. For now, we will stick with lightweight models, but we may switch if we find a better match in the future :)</p>
<a href="#misclassifications"><h3 id="misclassifications"><span class="hanchor" ariaLabel="Anchor"># </span>Misclassifications</h3></a>
<p>Of course, this algorithm isn’t perfect. It does have a lot of flaws and weaknesses that we find every day, and we’re working to fix those! If there are any misclassifications that you find in the algorithm, we love to hear about it on our feedback form: 
<a href="https://forms.gle/ctypb6FmDT9RQqjv6" rel="noopener">https://forms.gle/ctypb6FmDT9RQqjv6</a>.</p>
<a href="#closing"><h2 id="closing"><span class="hanchor" ariaLabel="Anchor"># </span>Closing</h2></a>
<p>This NLP model is at the core of reflect. It is this model’s goal to predict whether user intents are valid or not. As a result, we need to make sure this algorithm is accurate, fast, and lightweight. Hopefully, through this blog post, you’ve learned a little about how we went about building a model to fulfill those requirements.</p>
<p>Learn more about us on our website! ✨ 
<a href="http://getreflect.app/" rel="noopener">http://getreflect.app/</a></p>
<p>If you have any further questions about reflect or this NLP model, feel free to shoot us an email at 





<a
  
  rel="noopener" class="internal-link broken"
  data-src="mailto:hello@getreflect.app">hello@getreflect.app</a></p>


    </article>
    <hr/>


<div class="page-end" id="footer">
    <div class="backlinks-container">
        <h3>Backlinks</h3>
<ul class="backlinks">
    
    
    
    
    
    
    
    
    
      
      
      
    
      
      
      
    
      
      
      <li>
        <a href="/thoughts/digital-mindfulness/" data-ctx="reflect" data-src="/thoughts/digital-mindfulness" class="internal-link">Digital Mindfulness</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/search/" data-ctx="reflect" data-src="/thoughts/search" class="internal-link">Search</a>
      </li>
      
      
      
</ul>

    </div>
    <div>
        <script
  src="https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js"
  integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI="
  crossorigin="anonymous"
></script>
<h3>Interactive Graph</h3>
<div id="graph-container"></div>
<style>
  :root {
    --g-node: var(--secondary);
    --g-node-active: var(--primary);
    --g-node-inactive: var(--visited);
    --g-link: var(--outlinegray);
    --g-link-active: #5a7282;
  }
</style>

<script src="https://jzhao.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js"></script>

    </div>
</div>






<div id="contact_buttons">
    <footer>
        
        
        <p>Made by Jacky Zhao using <a href="https://github.com/jackyzha0/quartz">Quartz</a>, © 2022</p>
        <ul>
            
            <li><a href="https://jzhao.xyz/">Home</a></li>
            <li><a href="https://twitter.com/_jzhao">Twitter</a></li><li><a href="https://github.com/jackyzha0">GitHub</a></li></ul>
    </footer>
</div>


</div>
</body>
</html>
