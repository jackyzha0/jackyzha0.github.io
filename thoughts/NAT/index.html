<!DOCTYPE html>
<html lang="en">



<head>
  
  <meta charset="UTF-8" />
  <meta
    name="description"
    content="Network Address Translation Both network and transport layer (violation of abstraction/layering) More devices than IP addresses! What do we do?"
  />
  <meta property="og:title" content="Network Address Translation (NAT)">
  <meta property="og:description" content="Network Address Translation Both network and transport layer (violation of abstraction/layering) More devices than IP addresses! What do we do?">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jzhao.xyz/thoughts/NAT/">
  <meta property="og:width" content="200">
  <meta property="og:height" content="200">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Network Address Translation (NAT)" />
  <meta name="twitter:description" content="Network Address Translation Both network and transport layer (violation of abstraction/layering) More devices than IP addresses! What do we do?" />
  <meta name="twitter:image" content="https://jzhao.xyz/icon.png">
  
    
      
      <meta name="twitter:site" content="_jzhao" />
    
  
    
  

  <title>
    Network Address Translation (NAT)
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <meta property="og:url" content="https://jzhao.xyz" />
  <meta property="og:title" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="https://jzhao.xyz/res/og-card.png" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@_jzhao">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="https://jzhao.xyz/res/og-card.png" />


  
  
  
  
  
  <link rel="shortcut icon" type="image/png"  href="https://jzhao.xyz//icon.png" />
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <link href="https://jzhao.xyz/styles.e09a3335dd9cee04bce1105861b55ed5.min.css" rel="stylesheet" />

  
  <link href="https://jzhao.xyz/styles/_light_syntax.32359fa0e4ad5c5b354cb209e7fa1b22.min.css" rel="stylesheet" id="theme-link">

   
  
  
  
  
  <script src="https://jzhao.xyz/js/darkmode.182a2b4c9451f6f751c276a71c985624.min.js"></script>
  
  
  
  <script src="https://jzhao.xyz/js/util.763a7adef953af01d5a19b4d3dbd3455.min.js"></script>
  
  
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" as="style"
      onload="this.onload=null;this.rel='stylesheet'"
      integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
        integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
        crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
        integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
        crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js"
        integrity="sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A"
        crossorigin="anonymous"></script>


  
  



  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1"></script>
  
  <script defer src="https://jzhao.xyz/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js"></script>

  
  
  
  <script defer src="https://jzhao.xyz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js"></script>
  

  
  
  <script defer src="https://jzhao.xyz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js"></script>
  

  

  
   
  <script>
    
    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const lastVisit = localStorage.getItem('lastVisitTime')
    const now = Date.now()
    let show = 'true'
    if (lastVisit) {
      document.documentElement.setAttribute('visited', 'true')
      const minElapsed = Math.ceil((now - parseInt(lastVisit)) / (1000 * 60))
      show = (!isReducedMotion && minElapsed > 5) ? 'true' : 'false'
    }
    document.documentElement.setAttribute('show-animation', show)
    localStorage.setItem('lastVisitTime', `${now}`)

    const SEARCH_ENABLED =  false 
    const LATEX_ENABLED =  true 
    const PRODUCTION =  true 
    const BASE_URL = "https://jzhao.xyz/"
    const fetchData = Promise.all([
          fetch("https:\/\/jzhao.xyz\/indices\/linkIndex.39117367bae1afdc7fc1c31a73214a25.min.json")
            .then(data => data.json())
            .then(data => ({
              index: data.index,
              links: data.links,
            })),
          fetch("https:\/\/jzhao.xyz\/indices\/contentIndex.2927c2c9b6aadfd5075f82ca6b56aa4b.min.json")
            .then(data => data.json()),
        ])
        .then(([{index, links}, content]) => ({
          index,
          links,
          content,
        }))

      const render = () => {
      

      const siteBaseURL = new URL(BASE_URL);
      const pathBase = siteBaseURL.pathname;
      const pathWindow = window.location.pathname;
      const isHome = pathBase == pathWindow;

      addCopyButtons();
      

      addTitleToCodeBlocks();
      

      

      
      initPopover(
        "https://jzhao.xyz",
         true 

      )
      

      
      const footer = document.getElementById("footer")
      if (footer) {
        const container = document.getElementById("graph-container")
        
        if (!container) return requestAnimationFrame(render)
        
        container.textContent = ""

        const drawGlobal = isHome &&  false ;
        drawGraph(
            "https://jzhao.xyz",
            drawGlobal,
            [{"/moc":"#4388cc"}],
            drawGlobal ? {"centerForce":1,"depth":-1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.5,"linkDistance":1,"opacityScale":3,"repelForce":1,"scale":1.4} : {"centerForce":1,"depth":1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.6,"linkDistance":0.8,"opacityScale":3,"repelForce":2,"scale":1}
          );

        }
      

      
        var els = document.getElementsByClassName("mermaid");
        if (els.length > 0) {
          import('https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs').then(
            (obj) => {
              
              
              obj.default.init();
            }
          )
        }
      
      
      
      function clickHandler(evt) {
        const target = evt.target 
        const classNames = target.className.split(" ")
        const broken = classNames.includes("broken")
        const internal = classNames.includes("internal-link")
        plausible("Link Click", {
          props: {
            href: target.href,
            broken,
            internal,
            graph: false,
          }
        })
      }

      const links = document.querySelectorAll("a")
      for (link of links) {
        if (link.className.includes("root-title")) {
          link.addEventListener('click', clickHandler, {once: true})
        }
      }
    }

    const init = (doc = document) => {
      
      addCopyButtons();
      

      addTitleToCodeBlocks();
      renderMathInElement(doc.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
        ],
        macros: {
          '’': "'"
        },
        throwOnError : false
      });
      
    };
  </script>
  
  
  <script type="module">
    import { attachSPARouting } from "https:\/\/jzhao.xyz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script>
  
  
  <script defer data-domain="jzhao.xyz" src="https://plausible.io/js/script.js"></script>
  <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
</head>


<body>
<div id="search-container">
  <div id="search-space">
    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search"
      placeholder="Search for something..." dir="">
    <div id="results-container">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js"
  integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin="anonymous" defer></script>

<script defer src="https://jzhao.xyz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js"></script>



<div id="cursor-chat-layer">
  <input type="text" id="cursor-chat-box">
</div>
<script type="module">
  import { initCursorChat } from 'https://esm.sh/cursor-chat'
  initCursorChat("jzhao.xyz")
</script>

<div class="singlePage">
    
    <header class="delay t-1">
    <h1 id="page-title"><a class="root-title" href="https://jzhao.xyz/">jzhao.xyz</a></h1>
    <div class="spacer"></div>
    <div id="search-icon">
      <p>Search</p>
      <svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg>
    </div>
    <div class='darkmode'>
    <input class='toggle' id='darkmode-toggle' type='checkbox' tabindex="-1">
    <label id="toggle-label-light" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve">
            <title>Light Mode</title>
            <path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z" />
        </svg>
    </label>
    <label id="toggle-label-dark" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xml:space="preserve">
            <title>Dark Mode</title>
            <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z" />
        </svg>
    </label>
</div>

</header>


    <article>
      <h1>Network Address Translation (NAT)</h1>
      <p class="meta">
        Last updated 
Feb 26, 2022

 
          
<a href="https://github.com/jackyzha0/quartz/tree/hugo/content/thoughts/NAT.md" rel="noopener">Edit Source</a>


      </p>
      <ul class="tags">
    
    <li><a href="https://jzhao.xyz/tags/seed/">Seed</a></li>
    
    <li><a href="https://jzhao.xyz/tags/CPSC317/">CPSC317</a></li>
    
</ul>

      


      






  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  









  
  
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
      
      
    
    
    
      
      
      
      
      
      
      
    
    

    
    
      
      
      
      
      
      
        
        
        
          
          
          
        
        
      
    
    

  

  
  
  
    
  
    
  
    
  
    
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
      
      
    
    
    
      
      
      
      
      
      
      
    
    

    
    
      
      
      
      
      
      
        
        
        
          
          
          
        
        
      
    
    

  












<a href="#network-address-translation"><h2 id="network-address-translation"><span class="hanchor" ariaLabel="Anchor"># </span>Network Address Translation</h2></a>
<p>Both network and 





<a
  href="/thoughts/Transport-Layer/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/Transport-Layer/">transport layer</a> (violation of abstraction/layering) More devices than 





<a
  href="/thoughts/IP-Address/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/IP-Address/">IP addresses</a>! What do we do?</p>
<ol>
<li>Home router gets assigned an IP (public IP) by the ISP</li>
<li>Devices connected on the local network are assigned a private IP address (usually starts with subnet mask 196.168.x.x or 10.x.x.x)</li>
<li>Changes the private IP address to the public address of the router
<ol>
<li>Changes source port to some available port</li>
</ol>
</li>
<li>Adds the mapping to the NAT forwarding table
<ol>
<li>Entries correspond to private side (192.168.1.3:42301) to public side (12.13.14.15:24604)</li>
<li>Includes
<ol>
<li>Source IP</li>
<li>Source Port</li>
<li>Destination IP</li>
<li>Destination Port</li>
<li>





<a
  href="/thoughts/Protocol/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/Protocol/">Protocol</a></li>
<li>NAT IP (Router public IP address)</li>
<li>NAT Port (Unique)</li>
</ol>
</li>
<li>Actually, Port Forwarding just adds entries to the NAT forwarding table! You can set remote IP and remote port to wildcard entries (i.e. any web requests made to this port go to the specified machine)
<ol>
<li>Max number of rows is 65535</li>
<li>Any requests that come in then <em>clone</em> the wildcard rule and make it specific to that conversation (to avoid collisions to the NAT port)</li>
<li>Entries are removed when a conversation is coming to a close (stream based protocol, detect termination packets)</li>
</ol>
</li>
</ol>
</li>
<li>Does the inverse when it receives a packet</li>
</ol>
<p>


<img src="https://jzhao.xyz//thoughts/images/NAT.jpeg" width="auto" alt=""  /></p>
<a href="#hole-punching-and-nat-traversal"><h2 id="hole-punching-and-nat-traversal"><span class="hanchor" ariaLabel="Anchor"># </span>Hole-punching and NAT Traversal</h2></a>
<blockquote>
<p>Hole punching (or sometimes punch-through) is a technique in computer networking for establishing a direct connection between two parties in which one or both are behind firewalls or behind routers that use network address translation (NAT).</p>
</blockquote>
<p>Generally done using <a href="/thoughts/UDP" rel="noopener" class="internal-link" data-src="/thoughts/UDP">UDP</a>. You <em>can</em> do NAT traversal with TCP, but it adds another layer of complexity</p>
<p>Mostly used in 





<a
  href="/thoughts/decentralization/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/decentralization/">decentralized</a> or 





<a
  href="/thoughts/peer-to-peer/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/peer-to-peer/">peer-to-peer</a> communication as the latency incurred by relaying through a central server is prohibitively expensive for real-time activity like voice calling, file syncing, etc.</p>
<p>Hole-punching usually involves the use of third-party hosts that run STUN or ICE to figure out the public address of the NAT.</p>
<p>The idea is that to allow packets to come in from a remote endpoint, the computer behind the NAT or firewall needs to send something to the remote endpoint first. By doing so it creates a “hole” in the NAT or firewall through which communications can proceed. This even works when both sides are behind a NAT/firewall, when both sides start by punching a hole in their respective NAT/firewalls.</p>
<p>Types of NAT/Firewall combinations</p>
<ol>
<li>Endpoint-Independent Mapping (EIM): all outgoing connections from the same IP address and port have the same modified IP address and port</li>
<li>Address-Dependent Mapping (ADM): each outgoing connection to a different address from the same IP address and port has a different modified IP address and port</li>
<li>Address and Port-Dependent Mapping (APDM): same as ADM, instead of just address, it&rsquo;s address + port</li>
<li>Endpoint-Independent Filtering (EIF): all packets from remote addresses are allowed for a single endpoint on the NAT/Firewall</li>
<li>Address-Dependent Filtering (ADF): only allows packets to a specific endpoint from a specific address if a computer behind the NAT/Firewall has sent a packet to that address</li>
<li>Address and Port-Dependent Filtering (APDF): same as ADF but instead of just address, it&rsquo;s address + port</li>
</ol>
<a href="#efficacy"><h3 id="efficacy"><span class="hanchor" ariaLabel="Anchor"># </span>Efficacy</h3></a>
<p>From 
<a href="https://link.springer.com/content/pdf/10.1007/978-3-642-20798-3_1.pdf" rel="noopener"><em>UDP NAT and Firewall Puncturing in the Wild</em> by Gertjan Halkes and Johan Pouwelse</a></p>
<ul>
<li>Over 79% of peers on the Internet are not directly connectable
<ul>
<li>Using a simple redez-vouz mechanism decreases this to ~15% of peers</li>
<li>Keep-alive messages should be sent at least every 55 seconds to ensure that mappings/holes will remain open on almost every NAT/firewall</li>
</ul>
</li>
<li>Firewalls and NAT makes establishing P2P connections directly between any two machines hard
<ul>
<li>Firewalls are frequently configured to allow only outgoing connections, based on the assumption of the client-server model of communication</li>
<li>NAT hides the &rsquo;true&rsquo; port and IP combination of any machine that is behind it, meaning that connecting to an arbitrary port is often not allowed</li>
</ul>
</li>
<li>Mostly useful for UDP traffic as setting up a connecting for TCP when NAT/firewall requires unusual or non-standard use of TCP and IP mechanisms, and may rely on specific NAT/firewall behaviour to work</li>
<li>Detection
<ul>
<li>NAT
<ul>
<li>A and B report the remote address and port they see when a connection is set up. They now know their own external address and port</li>
<li>If all other peers agree on peer A&rsquo;s remote address and port, peer A determines they have no NAT or the NAT has EIM behaviour</li>
<li>If peer A&rsquo;s remote address and port are reported differ among peers, peer A determines they are behind a A(P)DM NAT</li>
</ul>
</li>
<li>Filtering Behaviour
<ul>
<li>Check order of requests received when connecting to a rendez-vous server
<ul>
<li>Side note: this many not always be true. The reason for this is that the direct connection request is not always faster than the reverse connection request which is sent through the rendez-vous peer. This is known as a Triangle Inequality Violation (TIV)</li>
<li>This can happen as often as 40% of the time although lower numbers are more common</li>
</ul>
</li>
<li>When a peer A tries to set up a connection using rendezvous R, it will always first send a direct connection request to the remote peer B
<ul>
<li>If the direct connection request from A to B arrives first, there is no filtering behaviour or it uses EIF</li>
<li>If the rendez-vouz connection request from R to B arrives first, the filtering behaviour is most likely A(P)DF</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/thoughts/images/NAT-firewall-share.png" width="auto" /></p>
<p><img src="/thoughts/images/NAT-firewall-connection-rates.png" width="auto" /></p>
<p>Possible explanations for a non-100% connection rate even in EIM-EIF to EIM-EIF peers</p>
<ul>
<li>UDP packets being dropped under high UDP packet load (especially in consumer-grade NAT/firewalls)</li>
<li>Routers stop functioning when mapping tables are full (not out of the realm of possibilies, only 65535 entries)</li>
<li>Use of 
<a href="https://en.wikipedia.org/wiki/Carrier-grade_NAT" rel="noopener">CGNAT</a> (NAT at the ISP level instead of home-router)</li>
</ul>
<a href="#terminology-translation-table"><h3 id="terminology-translation-table"><span class="hanchor" ariaLabel="Anchor"># </span>Terminology Translation Table</h3></a>
<p>
<a href="https://tailscale.com/blog/how-nat-traversal-works/" rel="noopener">NAT Cone Types</a></p>
<table>
<thead>
<tr>
<th></th>
<th>Endpoint-Independent NAT Mapping (EIM)</th>
<th>Endpoint-Dependent NAT Mapping (ADM/EDM)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Endpoint-Independent Firewall (EIF)</td>
<td>Full cone NAT</td>
<td>n/a</td>
</tr>
<tr>
<td>Endpoint IP-Dependent Firewall (ADF)</td>
<td>Restricted Cone NAT</td>
<td>n/a</td>
</tr>
<tr>
<td>Endpoint IP and Port-Dependent Firewall (APDF)</td>
<td>Port-restricted Cone NAT</td>
<td>Symmetric NAT</td>
</tr>
</tbody>
</table>
<a href="#flow"><h3 id="flow"><span class="hanchor" ariaLabel="Anchor"># </span>Flow</h3></a>
<p>Let $A$ and $B$ be the two hosts, each in its own private network; $N_A$ and $N_B$ are the two NAT devices with globally reachable IP addresses $EIP_A$ and $EIP_B$ respectively. $S$ is a public server with a well-known, globally reachable IP address.</p>
<ol>
<li>A and B both begin a 





<a
  href="/thoughts/UDP/"
  rel="noopener" class="internal-link"
  data-src="/thoughts/UDP/">UDP</a> conversation with $S$</li>
<li>NAT devices $N_A$ and $N_B$ create UDP translations and assign temporary external ports $EP_A$ and $EP_B$</li>
<li>S looks at UDP packets to get source ports of $N_A$ and $N_B$ (through $EP_A$ and $EP_B$)</li>
<li>S makes pairs of external IP addresses assigned by the NAT along with temporary external ports and exchanges them between $A$ and $B$ (S passes $EIP_A:EP_A$ to $B$ and $EIP_B:EP_B$ to $A$)</li>
<li>$A$ and $B$ send packets to each other and their appropriate NAT devices create the entries in their lookup tables
<ol>
<li>$A$ sends a packet to $EIP_B:EP_B$.</li>
<li>$N_A$ examines $A$&rsquo;s outgoing packet and adds (Source-IP-$A$, $EP_A$, $EIP_B$, $EP_B$) to its translation table.</li>
<li>$B$ sends a packet to $EIP_A:EP_A$.</li>
<li>$N_B$ examines $B$&rsquo;s outgoing packet and adds (Source-IP-$B$, $EP_B$, $EIP_A$, $EP_A$) to its translation table.</li>
</ol>
</li>
<li>Best case scenario $N_A$ and $N_B$ should have made the entry in the translation. Worst case, both NAT devices have not yet made the entry and drop the first packet sent from $B$</li>
<li>At worst, the second packet from both $A$ and $B$ make it to each other. Holes have been &ldquo;punched&rdquo; in the NAT and both hosts can directly communicate through $N_A$ and $N_B$ without needing $S$</li>
</ol>
<a href="#strategies-for-robust-nat-traversal"><h2 id="strategies-for-robust-nat-traversal"><span class="hanchor" ariaLabel="Anchor"># </span>Strategies for Robust NAT Traversal</h2></a>
<p>From 
<a href="https://tailscale.com/blog/how-nat-traversal-works/" rel="noopener">Tailscale</a></p>
<ul>
<li>A UDP-based protocol to augment</li>
<li>Direct access to a socket in your program</li>
<li>A communication side channel with your peers</li>
<li>A couple of STUN servers</li>
<li>A network of fallback relays (optional, but highly recommended)</li>
</ul>
<p>Then, you need to:</p>
<ul>
<li>Enumerate all the <code>ip:ports</code> for your socket on your directly connected interfaces</li>
<li>Query STUN servers to discover WAN <code>ip:ports</code> and the “difficulty” of your NAT, if any</li>
<li>Try using the port mapping protocols to find more WAN <code>ip:ports</code></li>
<li>Check for NAT64 and discover a WAN <code>ip:port</code> through that as well, if applicable</li>
<li>Exchange all those <code>ip:ports</code> with your peer through your side channel, along with some cryptographic keys to secure everything.</li>
<li>Begin communicating with your peer through fallback relays (optional, for quick connection establishment)</li>
<li>Probe all of your peer’s <code>ip:ports</code> for connectivity and if necessary/desired, also execute birthday attacks to get through harder NATs</li>
<li>As you discover connectivity paths that are better than the one you’re currently using, transparently upgrade away from the previous paths.</li>
<li>If the active path stops working, downgrade as needed to maintain connectivity.</li>
<li>Make sure everything is encrypted and authenticated end-to-end.</li>
</ul>
<a href="#peer-discovery-in-a-purely-distributed-manner"><h3 id="peer-discovery-in-a-purely-distributed-manner"><span class="hanchor" ariaLabel="Anchor"># </span>Peer Discovery in a purely distributed manner</h3></a>
<ol>
<li>Peer A sends an introduction-request to peer B. Peer B is chosen from an existing pool of neighboring peers.</li>
<li>Peer B sends an introduction-response to peer A containing the address of peer C.</li>
<li>Peer B sends a puncture-request to peer C containing the address of peer A.</li>
<li>Peer C sends a puncture to peer A, puncturing its NAT.</li>
</ol>
<p>When a peer doesn’t yet have a list of neighboring peers, it will select a bootstrap server for peer B. Bootstrap servers have the same peer discovery protocol as regular peers except they respond to introduction-requests for anyone.</p>
<a href="#stun-session-traversal-utilities-for-nat"><h3 id="stun-session-traversal-utilities-for-nat"><span class="hanchor" ariaLabel="Anchor"># </span>STUN (Session Traversal Utilities for NAT)</h3></a>
<p>Servers like $S$ usually run STUN. Recognized using a <code>stun</code> or <code>stuns</code> resource record.</p>
<p>Details how a server can determine what kind of NAT and firewall is between itself and the public Internet.</p>
<a href="#ice-interactive-connectivity-establishment"><h3 id="ice-interactive-connectivity-establishment"><span class="hanchor" ariaLabel="Anchor"># </span>ICE (Interactive Connectivity Establishment)</h3></a>
<p>Uses STUN. Provides a structured mechanism to determine the optimal communication path between two peers</p>
<a href="#turn-traversal-using-relays-around-nat"><h3 id="turn-traversal-using-relays-around-nat"><span class="hanchor" ariaLabel="Anchor"># </span>TURN (Traversal Using Relays around NAT)</h3></a>
<p>TURN places a third-party server to relay messages between two clients when direct media traffic between peers is not allowed by a firewall.</p>


    </article>
    <hr/>


<div class="page-end" id="footer">
    <div class="backlinks-container">
        <h3>Backlinks</h3>
<ul class="backlinks">
    
    
    
    
    
    
    
    
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      <li>
        <a href="/posts/agentic-computing/" data-ctx="NAT" data-src="/posts/agentic-computing" class="internal-link">Agentic Computing</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Rhizome-Philosophy/" data-ctx="NAT" data-src="/thoughts/Rhizome-Philosophy" class="internal-link">Rhizome Philosophy</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Rhizome-Research-Log/" data-ctx="NAT traversal and holepunching efficacy" data-src="/thoughts/Rhizome-Research-Log" class="internal-link">Rhizome Research Log</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/computer-networking/" data-ctx="NAT" data-src="/thoughts/computer-networking" class="internal-link">Intro to Computer Networking &amp; P2P</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/internet-computing/" data-ctx="NAT" data-src="/thoughts/internet-computing" class="internal-link">Internet Computing</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/local-first-software/" data-ctx="NAT" data-src="/thoughts/local-first-software" class="internal-link">Local-first software</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/systems-design/" data-ctx="thoughts/NAT" data-src="/thoughts/systems-design" class="internal-link">Systems Design</a>
      </li>
      
      
      
</ul>

    </div>
    <div>
        <script
  src="https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js"
  integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI="
  crossorigin="anonymous"
></script>
<h3>Interactive Graph</h3>
<div id="graph-container"></div>
<style>
  :root {
    --g-node: var(--secondary);
    --g-node-active: var(--primary);
    --g-node-inactive: var(--visited);
    --g-link: var(--outlinegray);
    --g-link-active: #5a7282;
  }
</style>

<script src="https://jzhao.xyz/js/graph.6579af7b10c818dbd2ca038702db0224.js"></script>

    </div>
</div>






<div id="contact_buttons">
    <footer>
        
        
        <p>This page was made by Jacky Zhao using <a href="https://github.com/jackyzha0/quartz">Quartz</a>, © 2023</p>
        <ul>
            
            <li><a href="https://jzhao.xyz/">Home</a></li>
            <li><a href="https://twitter.com/_jzhao">Twitter</a></li><li><a href="https://github.com/jackyzha0">GitHub</a></li></ul>
    </footer>
</div>


</div>
</body>
</html>
