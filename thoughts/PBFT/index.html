<!DOCTYPE html>
<html lang="en">



<head>
  
  <meta charset="UTF-8" />
  <meta
    name="description"
    content="Practical Byzantine Fault Tolerance by Miguel Castro and Barbara Liskov
TLDR; one of the first [[thoughts/State Machine Replication (SMR)|state machine replication]] algorithms with an asynchronous [[thoughts/system model|system model]] that can tolerate [[thoughts/Byzantine Faults|Byzantine faults]] (although it has a weak synchrony assumption where all messages are guaranteed to be delivered after a certain time bound by using timeouts)."
  />
  <meta property="og:title" content="PBFT">
  <meta property="og:description" content="Practical Byzantine Fault Tolerance by Miguel Castro and Barbara Liskov
TLDR; one of the first [[thoughts/State Machine Replication (SMR)|state machine replication]] algorithms with an asynchronous [[thoughts/system model|system model]] that can tolerate [[thoughts/Byzantine Faults|Byzantine faults]] (although it has a weak synchrony assumption where all messages are guaranteed to be delivered after a certain time bound by using timeouts).">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jzhao.xyz/thoughts/PBFT/">
  <meta property="og:width" content="200">
  <meta property="og:height" content="200">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="PBFT" />
  <meta name="twitter:description" content="Practical Byzantine Fault Tolerance by Miguel Castro and Barbara Liskov
TLDR; one of the first [[thoughts/State Machine Replication (SMR)|state machine replication]] algorithms with an asynchronous [[thoughts/system model|system model]] that can tolerate [[thoughts/Byzantine Faults|Byzantine faults]] (although it has a weak synchrony assumption where all messages are guaranteed to be delivered after a certain time bound by using timeouts)." />
  <meta name="twitter:image" content="https://jzhao.xyz/icon.png">
  
    
      
      <meta name="twitter:site" content="_jzhao" />
    
  
    
  

  <title>
    PBFT
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <meta property="og:url" content="https://jzhao.xyz" />
  <meta property="og:title" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="https://jzhao.xyz/res/og-card.png" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@_jzhao">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="https://jzhao.xyz/res/og-card.png" />


  
  
  
  
  
  <link rel="shortcut icon" type="image/png"  href="https://jzhao.xyz//icon.png" />
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <link href="https://jzhao.xyz/styles.afc1e7564b97dfc80fd238ef2d9aa8f3.min.css" rel="stylesheet" />

  
  <link href="https://jzhao.xyz/styles/_light_syntax.32359fa0e4ad5c5b354cb209e7fa1b22.min.css" rel="stylesheet" id="theme-link">

   
  
  
  
  
  <script src="https://jzhao.xyz/js/darkmode.182a2b4c9451f6f751c276a71c985624.min.js"></script>
  
  
  
  <script src="https://jzhao.xyz/js/util.763a7adef953af01d5a19b4d3dbd3455.min.js"></script>
  
  
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" as="style"
      onload="this.onload=null;this.rel='stylesheet'"
      integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
        integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
        crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
        integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
        crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js"
        integrity="sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A"
        crossorigin="anonymous"></script>


  
  



  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1"></script>
  
  <script defer src="https://jzhao.xyz/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js"></script>

  
  
  
  <script defer src="https://jzhao.xyz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js"></script>
  

  
  
  <script defer src="https://jzhao.xyz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js"></script>
  

  

  
   
  <script>
    
    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const lastVisit = localStorage.getItem('lastVisitTime')
    const now = Date.now()
    let show = 'true'
    if (lastVisit) {
      document.documentElement.setAttribute('visited', 'true')
      const minElapsed = Math.ceil((now - parseInt(lastVisit)) / (1000 * 60))
      show = (!isReducedMotion && minElapsed > 5) ? 'true' : 'false'
    }
    document.documentElement.setAttribute('show-animation', show)
    localStorage.setItem('lastVisitTime', `${now}`)

    const SEARCH_ENABLED =  false 
    const LATEX_ENABLED =  true 
    const PRODUCTION =  true 
    const BASE_URL = "https://jzhao.xyz/"
    const fetchData = Promise.all([
          fetch("https:\/\/jzhao.xyz\/indices\/linkIndex.95bb332eecac3119b9c07d31e14c88da.min.json")
            .then(data => data.json())
            .then(data => ({
              index: data.index,
              links: data.links,
            })),
          fetch("https:\/\/jzhao.xyz\/indices\/contentIndex.d33ea1daab0d5ee6d6e20c6d0048ea1f.min.json")
            .then(data => data.json()),
        ])
        .then(([{index, links}, content]) => ({
          index,
          links,
          content,
        }))

      const render = () => {
      

      const siteBaseURL = new URL(BASE_URL);
      const pathBase = siteBaseURL.pathname;
      const pathWindow = window.location.pathname;
      const isHome = pathBase == pathWindow;

      addCopyButtons();
      

      addTitleToCodeBlocks();
      

      

      
      initPopover(
        "https://jzhao.xyz",
         true 

      )
      

      
      const footer = document.getElementById("footer")
      if (footer) {
        const container = document.getElementById("graph-container")
        
        if (!container) return requestAnimationFrame(render)
        
        container.textContent = ""

        const drawGlobal = isHome &&  false ;
        drawGraph(
            "https://jzhao.xyz",
            drawGlobal,
            [{"/moc":"#4388cc"}],
            drawGlobal ? {"centerForce":1,"depth":-1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.5,"linkDistance":1,"opacityScale":3,"repelForce":1,"scale":1.4} : {"centerForce":1,"depth":1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.6,"linkDistance":0.8,"opacityScale":3,"repelForce":2,"scale":1}
          );

        }
      

      
        var els = document.getElementsByClassName("mermaid");
        if (els.length > 0) {
          import('https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs').then(
            (obj) => {
              
              
              obj.default.init();
            }
          )
        }
      
      
      
      function clickHandler(evt) {
        const target = evt.target 
        const classNames = target.className.split(" ")
        const broken = classNames.includes("broken")
        const internal = classNames.includes("internal-link")
        plausible("Link Click", {
          props: {
            href: target.href,
            broken,
            internal,
            graph: false,
          }
        })
      }

      const links = document.querySelectorAll("a")
      for (link of links) {
        if (link.className.includes("root-title")) {
          link.addEventListener('click', clickHandler, {once: true})
        }
      }
    }

    const init = (doc = document) => {
      
      addCopyButtons();
      

      addTitleToCodeBlocks();
      renderMathInElement(doc.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
        ],
        macros: {
          '’': "'"
        },
        throwOnError : false
      });
      
    };
  </script>
  
  
  <script type="module">
    import { attachSPARouting } from "https:\/\/jzhao.xyz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script>
  
  
  <script defer data-domain="jzhao.xyz" src="https://plausible.io/js/script.js"></script>
  <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
</head>


<body>
<div id="search-container">
  <div id="search-space">
    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search"
      placeholder="Search for something..." dir="">
    <div id="results-container">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js"
  integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin="anonymous" defer></script>

<script defer src="https://jzhao.xyz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js"></script>



<div id="cursor-chat-layer">
  <input type="text" id="cursor-chat-box">
</div>
<script type="module">
  import { initCursorChat } from 'https://esm.sh/cursor-chat'
  initCursorChat("jacky-personal-website")
</script>

<div class="singlePage">
    
    <header class="delay t-1">
    <h1 id="page-title"><a class="root-title" href="https://jzhao.xyz/">jzhao.xyz</a></h1>
    <div class="spacer"></div>
    <div id="search-icon">
      <p>Search</p>
      <svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg>
    </div>
    <div class='darkmode'>
    <input class='toggle' id='darkmode-toggle' type='checkbox' tabindex="-1">
    <label id="toggle-label-light" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve">
            <title>Light Mode</title>
            <path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z" />
        </svg>
    </label>
    <label id="toggle-label-dark" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xml:space="preserve">
            <title>Dark Mode</title>
            <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z" />
        </svg>
    </label>
</div>

</header>


    <article>
      <h1>PBFT</h1>
      <p class="meta">
        Last updated 
Aug 5, 2022

 
          
<a href="https://github.com/jackyzha0/quartz/tree/hugo/content/thoughts/PBFT.md" rel="noopener">Edit Source</a>


      </p>
      <ul class="tags">
    
    <li><a href="https://jzhao.xyz/tags/seed/">Seed</a></li>
    
</ul>

      


      






  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  









  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
      
      
    
    
    
      
      
      
      
      
      
      
    
    

    
    
      
      
      
      
      
      
        
        
        
          
          
          
        
        
      
    
    

  

  
  
  

  

    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
      
      
      
      
      
    
    

  












<p><em>
<a href="http://css.csail.mit.edu/6.824/2014/papers/castro-practicalbft.pdf" rel="noopener">Practical Byzantine Fault Tolerance</a></em> by Miguel Castro and Barbara Liskov</p>
<p>TLDR; one of the first <a href="/thoughts/State-Machine-Replication-SMR" rel="noopener" class="internal-link" data-src="/thoughts/State-Machine-Replication-SMR">state machine replication</a> algorithms with an asynchronous <a href="/thoughts/system-model" rel="noopener" class="internal-link" data-src="/thoughts/system-model">system model</a> that can tolerate <a href="/thoughts/Byzantine-Faults" rel="noopener" class="internal-link" data-src="/thoughts/Byzantine-Faults">Byzantine faults</a> (although it has a weak synchrony assumption where all messages are guaranteed to be delivered after a certain time bound by using timeouts).</p>
<p>It can drive a consensus decision in two rounds of message exchanges.</p>
<ol>
<li>The first phase guarantees proposal uniqueness through the formation of a quorum certificate (QC) consisting of $(n − f)$ votes.</li>
<li>The second phase guarantees that the next leader can convince replicas to vote for a safe proposal.</li>
</ol>
<p>It offers both <a href="/thoughts/liveness" rel="noopener" class="internal-link" data-src="/thoughts/liveness">liveness</a> and <a href="/thoughts/safety" rel="noopener" class="internal-link" data-src="/thoughts/safety">safety</a> under the <a href="/thoughts/33-percent-Impossibility-Result" rel="noopener" class="internal-link" data-src="/thoughts/33-percent-Impossibility-Result">33 percent Impossibility Result</a> and only uses <a href="/thoughts/Asymmetric-Key-Cryptography" rel="noopener" class="internal-link" data-src="/thoughts/Asymmetric-Key-Cryptography">public-key cryptography</a> during faults to prevent major speed bottlenecks (typically just uses <a href="/thoughts/digital-signatures#signed-message-digest" rel="noopener" class="internal-link" data-src="/thoughts/digital-signatures">signed message digests</a>). This circumvents the <a href="/thoughts/FLP-Result" rel="noopener" class="internal-link" data-src="/thoughts/FLP-Result">FLP Result</a> because it relies on a synchrony assumption to guarantee liveness, not safety.</p>
<p>For a faster alternative, consider <a href="/thoughts/SBFT" rel="noopener" class="internal-link" data-src="/thoughts/SBFT">SBFT</a> (which provides a reduction from $O(n^2)$ to $O(n)$ normal-case communication and a best-case latency of only a single round of communication)</p>
<p>The primary of a view is replica $p$ such that $p = v \mod |\mathcal{R}|$ where $\mathcal{R}$ is the set of replicas. Note that this <em>explicitly allows for faulty primaries</em> while the algorithm properly handles.</p>
<p>The algorithm works as follows</p>
<ol>
<li>A client $c$ sends a request for operation $o$ to a node in the cluster: $\langle \textrm{Request}, o, t, c \rangle_{\sigma_c}$
<ol>
<li>If a replica receives the request, it forwards it to the leader</li>
</ol>
</li>
<li>The primary multicasts the request to the backup nodes in a three-phase protocol. The pre-prepare and prepare phases are used to totally order requests sent in the same view even when the primary, which proposes the ordering of requests, is faulty
<ol>
<li>Pre-prepare: mainly used to ensure request was assigned sequence number $n$ in view $v$. Primary $p$ assigns a sequence number $n$ to the request and multicasts a pre-prepare message with digest $m$: $\langle \langle \textrm{Pre-prepare}, v, n, d \rangle_{\sigma_p}, m \rangle$
<ol>
<li>A replica $i$ accepts a pre-prepare message iff:
<ol>
<li>It is in view $v$</li>
<li>$d$ is the digest for $m$ and the signature is correct</li>
<li>has not seen a pre-prepare message with the same $v$ and $n$ with a different digest $d$</li>
<li>sequence number is between some $h$ and $H$</li>
</ol>
</li>
</ol>
</li>
<li>Prepare
<ol>
<li>If replica $i$ accepts the pre-prepare message, it enters the prepare phase by multicasting a $\langle \textrm{Prepare}, v, n, d, i \rangle_{\sigma_i}$</li>
<li>We define a replica $i$ as prepared iff $i$ has in its log:
<ol>
<li>The request $m$</li>
<li>A pre-prepare for $m$ in view $v$ with sequence number $n$</li>
<li>$&gt;2f$ prepares that match the pre-prepare based on $v$, $n$, and $d$</li>
</ol>
</li>
</ol>
</li>
<li>Commit
<ol>
<li>If we are prepared, we have supermajority agreement which means all honest replicas agree on the requests in view $v$</li>
<li>Replica $i$ multicasts $\langle \textrm{Commit}, v, n, D(m), i \rangle_{\sigma_i}$</li>
<li>Replicas accept commit messages and insert them in their log provided they are properly signed, the view number in the message is equal to the replica’s current view, and the sequence number is between $h$ and $H$</li>
<li>This phase ensures that if a message is considered committed locally, then it should have been committed for the cluster
<ol>
<li>A message $m$ is considered committed locally on replica $i$ if it has a log entry indicating it has prepared $m$ with view $v$ and sequence number $n$ and has also accepted $2f+1$ commits that match the pre-prepare for $m$
<ol>
<li>After a $m$ is considered committed locally and all $m&rsquo;$ with lower $n$ have been executed, $i$ executes $m$ and applies the state change (as we don&rsquo;t assume ordered message delivery, keeping messages until ready is critical to ensuring message ordering)</li>
<li>$i$ then sends a reply to the client: $\langle \textrm{Reply}, v, t, c, i, r \rangle_{\sigma_i}$</li>
</ol>
</li>
<li>A message $m$ is considered committed on the cluster if for all $i$ in some $f+1$ honest replicas, it has a log entry indicating it has prepared $m$ with view $v$ and sequence number $n$</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>The client waits for $f + 1$ replies from different replicas with the same result; this is the end result
<ol>
<li>If the client doesn&rsquo;t receive replies in a timely manner, it broadcasts the request to all replicas. If the request has already been processed, the replicas simply re-send the reply (as replicas cache the last reply sent to each client)</li>
</ol>
</li>
</ol>
<p><img src="/thoughts/images/3pc-pbft.png" width="auto" /><em>Replica 0 is the primary, replica 3 is faulty, and C is the client</em></p>
<a href="#garbage-collection"><h2 id="garbage-collection"><span class="hanchor" ariaLabel="Anchor"># </span>Garbage Collection</h2></a>
<p>As we assume only asynchronous model, we can&rsquo;t assume any unresponsive node won&rsquo;t rejoin at some later point. So either, we need to keep all log entries around potentially forever (not idea), or have some way to transfer state between nodes (which requires nodes to prove correctness of state).</p>
<p>Generate state correctness proofs are expensive so only happen once every 100 sequence numbers (a stable checkpoint).</p>
<p>Proof generation:</p>
<ol>
<li>When a replica $i$ reaches a checkpoint, it multicasts a message $\langle \textrm{Checkpoint}, n, d, i \rangle_{\sigma_i}$ where $d$ is the digest of the state</li>
<li>A replica collects checkpoint messages until they have $2f+1$ messages for the same sequence number $n$ and digest $d$
<ol>
<li>$2f+1$ messages are the proof of correctness for the checkpoint</li>
<li>A checkpoint with a proof means that the replica is safe to discard all log messages related to sequence number $n$</li>
</ol>
</li>
</ol>
<p>Additionally, this checkpointing determines what the waterlevel $h$ and $H$ are</p>
<ul>
<li>$h$ is the sequence number of the last stable checkpoint</li>
<li>$H = h + k$ where $k$ is generally twice the gap between stable checkpoints (e.g. 200)</li>
</ul>
<a href="#view-changes"><h2 id="view-changes"><span class="hanchor" ariaLabel="Anchor"># </span>View Changes</h2></a>
<p>Similar to the concept of term changes and heartbeats in <a href="/thoughts/Raft-Consensus-Algorithm" rel="noopener" class="internal-link" data-src="/thoughts/Raft-Consensus-Algorithm">Raft</a></p>
<p>If the timer of replica $i$ expires in view $v$, it can broadcast a message to move the system to view $v + 1$</p>
<ul>
<li>It stops accepting messages (other than checkpoint, view change and new view messages)</li>
<li>Multicasts a $\langle \textrm{View-change}, v + 1, n , \mathcal C, \mathcal P, i \rangle_{\sigma_i}$ to all nodes
<ul>
<li>$n$ is the sequence number of the last stable checkpoint $s$ known to $i$</li>
<li>$\mathcal C$ is the set of $2f+1$ certificates for $s$</li>
<li>$\mathcal P$ is a set of sets $\mathcal{P}_m$ for each message $m$ with a sequence number higher than $n$</li>
<li>Each $\mathcal{P}_m$ is the set containing
<ul>
<li>A valid pre-prepare message for $m$</li>
<li>$2f$ matching valid prepare messages from different replicas</li>
</ul>
</li>
</ul>
</li>
<li>When the initiator $p$ of view $v + 1$ receives $2f$ valid view-change messages, it multicasts a new $\langle \textrm{New-view}, v + 1, \mathcal V, \mathcal O \rangle_{\sigma_p}$
<ul>
<li>$\mathcal V$ is the set of all received $2f$ view-change messages along with the initial view-change message $p$ sent out</li>
<li>$\mathcal O$ is the set of pre-prepare messages computed as follows:
<ul>
<li><em>min-s</em>: latest stable checkpoint in $\mathcal V$</li>
<li><em>max-s</em>: highest sequence number in a prepare message in $\mathcal V$</li>
<li>For each $n$ between <em>min-s</em> and <em>max-s</em>
<ul>
<li>If there is some message in $\mathcal P$ where the sequence number matches $n$
<ul>
<li>Create a new message $\langle \textrm{Pre-prepare}, v+1, n,d \rangle_{\sigma_p}$</li>
</ul>
</li>
<li>If there isn&rsquo;t
<ul>
<li>Create a new message $\langle \textrm{Pre-prepare}, v+1, n,d^{\textrm{null}} \rangle_{\sigma_p}$ where $d^{\textrm{null}}$ is the digest of a noop request</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Leader appends all messages in $\mathcal O$ to its log and enters view $v + 1$</li>
</ul>
</li>
</ul>


    </article>
    <hr/>


<div class="page-end" id="footer">
    <div class="backlinks-container">
        <h3>Backlinks</h3>
<ul class="backlinks">
    
    
    
    
    
    
    
    
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      
    
      
      
      <li>
        <a href="/thoughts/Byzantine-Faults/" data-ctx="PBFT" data-src="/thoughts/Byzantine-Faults" class="internal-link">Byzantine Faults</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/HotStuff/" data-ctx="PBFT" data-src="/thoughts/HotStuff" class="internal-link">HotStuff</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Rhizome-Research-Log/" data-ctx="PBFT" data-src="/thoughts/Rhizome-Research-Log" class="internal-link">Rhizome Research Log</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/SBFT/" data-ctx="PBFT" data-src="/thoughts/SBFT" class="internal-link">SBFT</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Solana/" data-ctx="PBFT" data-src="/thoughts/Solana" class="internal-link">Solana</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Tangaroa/" data-ctx="PBFT" data-src="/thoughts/Tangaroa" class="internal-link">Tangaroa</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/Tendermint/" data-ctx="PBFT" data-src="/thoughts/Tendermint" class="internal-link">Tendermint</a>
      </li>
      
      
      
      <li>
        <a href="/thoughts/consensus/" data-ctx="PBFT" data-src="/thoughts/consensus" class="internal-link">Consensus</a>
      </li>
      
      
      
</ul>

    </div>
    <div>
        <script
  src="https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js"
  integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI="
  crossorigin="anonymous"
></script>
<h3>Interactive Graph</h3>
<div id="graph-container"></div>
<style>
  :root {
    --g-node: var(--secondary);
    --g-node-active: var(--primary);
    --g-node-inactive: var(--visited);
    --g-link: var(--outlinegray);
    --g-link-active: #5a7282;
  }
</style>

<script src="https://jzhao.xyz/js/graph.6579af7b10c818dbd2ca038702db0224.js"></script>

    </div>
</div>






<div id="contact_buttons">
    <footer>
        
        
        <p>This page was made by Jacky Zhao using <a href="https://github.com/jackyzha0/quartz">Quartz</a>, © 2023</p>
        <ul>
            
            <li><a href="https://jzhao.xyz/">Home</a></li>
            <li><a href="https://twitter.com/_jzhao">Twitter</a></li><li><a href="https://github.com/jackyzha0">GitHub</a></li></ul>
    </footer>
</div>


</div>
</body>
</html>
